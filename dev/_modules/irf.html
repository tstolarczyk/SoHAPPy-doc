

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>irf &mdash; SoHAPPy 0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> SoHAPPy
          

          
          </a>

          
            
            
              <div class="version">
                dev
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sohappy.html">How it works ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../irf.html">Instrument response functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../file_format.html">Input file format</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Concepts and classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../grb.html">Astrophysical objects (GRB)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../time_slice.html">Time slices and slots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visibility.html">Visibilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../montecarlo.html">Monte Carlo</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analysis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../population_analysis.html">Population analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../source_analysis.html">Analyzing a single object</a></li>
<li class="toctree-l1"><a class="reference internal" href="../source_analysis.html#dataset-plotting">Dataset plotting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools.html">Dataset tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools.html#utilities">Utilities</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The developer corner</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">Todo list</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SoHAPPy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>irf</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for irf</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Thu Dec 12 09:01:41 2019</span>

<span class="sd">@author: Stolar</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">quantity_support</span>
<span class="kn">from</span> <span class="nn">gammapy.maps</span> <span class="kn">import</span> <span class="n">MapAxis</span>

<span class="kn">from</span> <span class="nn">gammapy.irf</span> <span class="kn">import</span> <span class="n">load_cta_irfs</span>

<span class="kn">import</span> <span class="nn">mcsim_config</span> <span class="k">as</span> <span class="nn">mcf</span>

<span class="c1"># Keyword lists and true values, also in log for time</span>
<span class="n">zenith_list</span> <span class="o">=</span>  <span class="p">{</span><span class="s2">&quot;20deg&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                <span class="s2">&quot;40deg&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                <span class="s2">&quot;60deg&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span> <span class="p">}</span>

<span class="n">dt_list</span>     <span class="o">=</span>  <span class="p">{</span><span class="s2">&quot;prod3&quot;</span><span class="p">:</span>
                    <span class="p">{</span><span class="s2">&quot;100s&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">),</span>
                     <span class="s2">&quot;30m&quot;</span>  <span class="p">:</span> <span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">),</span>
                     <span class="s2">&quot;5h&quot;</span>   <span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">),</span>
                     <span class="s2">&quot;50h&quot;</span>  <span class="p">:</span> <span class="p">(</span><span class="mi">50</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="p">},</span>
                 <span class="s2">&quot;prod5&quot;</span><span class="p">:</span>
                     <span class="p">{</span><span class="s2">&quot;1800s&quot;</span>  <span class="p">:</span> <span class="p">(</span><span class="mi">1800</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">),</span>   <span class="c1"># 30 min</span>
                      <span class="s2">&quot;18000s&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">18000</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">),</span>  <span class="c1"># 5h</span>
                      <span class="s2">&quot;180000s&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">180000</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)}</span> <span class="c1"># 50h</span>
                <span class="p">}</span>

<span class="n">dtl</span>         <span class="o">=</span>  <span class="p">{</span><span class="s2">&quot;prod3&quot;</span><span class="p">:</span>
                    <span class="p">{</span><span class="s2">&quot;100s&quot;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="mi">100</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                     <span class="s2">&quot;30m&quot;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="mi">30</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                     <span class="s2">&quot;5h&quot;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="mi">5</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                     <span class="s2">&quot;50h&quot;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="mi">50</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="p">},</span>
                <span class="s2">&quot;prod5&quot;</span><span class="p">:</span>
                    <span class="p">{</span><span class="s2">&quot;1800s&quot;</span>   <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="mi">1800</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>    <span class="c1"># 30 min</span>
                     <span class="s2">&quot;18000s&quot;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="mi">18000</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>   <span class="c1"># 5h</span>
                     <span class="s2">&quot;180000s&quot;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="mi">180000</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="p">}</span> <span class="c1"># 50h</span>
                <span class="p">}</span>

<span class="c1"># Validity range of IRF in zenith (see documentation of this module).</span>
<span class="c1"># The 60deg IRF is allowed to be used down to alitude zero for tests</span>
<span class="c1"># Its use is foreseen to be limited by the altmin variable</span>
<span class="n">zenith_valid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;20deg&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="mi">33</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">],</span>
                <span class="s2">&quot;40deg&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">33</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="mi">54</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">],</span>
                <span class="s2">&quot;60deg&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">54</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="mi">90</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">]</span> <span class="c1"># Should be limited by altmin</span>
                <span class="p">}</span>

<span class="c1"># Validity range of IRF in time, taking into account that the validity</span>
<span class="c1"># intervals are somehow in logarithmic scale.</span>
<span class="c1"># The edge values are the following :</span>
<span class="c1"># 0, 424.26 s, 5692.01 s (94.9&#39;), 56921.0 s (15.8h)</span>

<span class="n">dt_log_valid</span> <span class="o">=</span> \
<span class="p">{</span><span class="s2">&quot;prod3&quot;</span><span class="p">:</span>
    <span class="p">{</span><span class="s2">&quot;100s&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span>
             <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod3&quot;</span><span class="p">][</span><span class="s2">&quot;100s&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod3&quot;</span><span class="p">][</span><span class="s2">&quot;30m&quot;</span><span class="p">]</span> <span class="p">))</span> <span class="p">],</span>
    <span class="s2">&quot;30m&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod3&quot;</span><span class="p">][</span><span class="s2">&quot;100s&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod3&quot;</span><span class="p">][</span><span class="s2">&quot;30m&quot;</span><span class="p">]</span> <span class="p">)),</span>
             <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod3&quot;</span><span class="p">][</span><span class="s2">&quot;30m&quot;</span><span class="p">]</span>  <span class="o">+</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod3&quot;</span><span class="p">][</span><span class="s2">&quot;5h&quot;</span><span class="p">]</span> <span class="p">))</span> <span class="p">],</span>
    <span class="s2">&quot;5h&quot;</span>  <span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod3&quot;</span><span class="p">][</span><span class="s2">&quot;30m&quot;</span><span class="p">]</span>  <span class="o">+</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod3&quot;</span><span class="p">][</span><span class="s2">&quot;5h&quot;</span><span class="p">]</span> <span class="p">)),</span>
             <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod3&quot;</span><span class="p">][</span><span class="s2">&quot;5h&quot;</span><span class="p">]</span>  <span class="o">+</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod3&quot;</span><span class="p">][</span><span class="s2">&quot;50h&quot;</span><span class="p">]</span> <span class="p">))</span> <span class="p">],</span>
    <span class="s2">&quot;50h&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod3&quot;</span><span class="p">][</span><span class="s2">&quot;5h&quot;</span><span class="p">]</span>  <span class="o">+</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod3&quot;</span><span class="p">][</span><span class="s2">&quot;50h&quot;</span><span class="p">]</span> <span class="p">)),</span>
             <span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">]</span>
    <span class="p">},</span>
 <span class="s2">&quot;prod5&quot;</span><span class="p">:</span>
    <span class="p">{</span><span class="s2">&quot;1800s&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span>
                <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod5&quot;</span><span class="p">][</span><span class="s2">&quot;1800s&quot;</span><span class="p">]</span>  <span class="o">+</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod5&quot;</span><span class="p">][</span><span class="s2">&quot;18000s&quot;</span><span class="p">]</span> <span class="p">))],</span>
    <span class="s2">&quot;18000s&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod5&quot;</span><span class="p">][</span><span class="s2">&quot;1800s&quot;</span><span class="p">]</span>  <span class="o">+</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod5&quot;</span><span class="p">][</span><span class="s2">&quot;18000s&quot;</span><span class="p">]</span> <span class="p">)),</span>
                <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod5&quot;</span><span class="p">][</span><span class="s2">&quot;18000s&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod5&quot;</span><span class="p">][</span><span class="s2">&quot;180000s&quot;</span><span class="p">]</span> <span class="p">))],</span>
    <span class="s2">&quot;180000s&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod5&quot;</span><span class="p">][</span><span class="s2">&quot;18000s&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dtl</span><span class="p">[</span><span class="s2">&quot;prod5&quot;</span><span class="p">][</span><span class="s2">&quot;18000s&quot;</span><span class="p">])),</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Minimal acceptable energies depending on the IRF</span>
<span class="c1"># (resp. generated and reconstructed energies)</span>
<span class="c1">#</span>
<span class="c1"># The masking later will remove the bin containing the E value.</span>
<span class="c1"># If the E value is an edge, the subsequent bin is lost.</span>
<span class="c1"># The minimal and maximal energies need therefore to be slighlty</span>
<span class="c1"># before, resp. after the first, resp last edge of interest.</span>

<span class="n">safe_margin</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span>
<span class="n">egen_min</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;20deg&quot;</span><span class="p">:</span> <span class="mf">12.6</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span>
            <span class="s2">&quot;40deg&quot;</span><span class="p">:</span> <span class="mf">26.4</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span>
            <span class="s2">&quot;60deg&quot;</span><span class="p">:</span> <span class="mf">105.3</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span>
            <span class="p">}</span>

<span class="n">erec_min</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;FullArray&quot;</span>  <span class="p">:</span>    <span class="p">{</span><span class="s2">&quot;20deg&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span><span class="p">,</span>
                               <span class="s2">&quot;40deg&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span><span class="p">,</span>
                               <span class="s2">&quot;60deg&quot;</span><span class="p">:</span> <span class="mi">110</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span>
                              <span class="p">},</span>
            <span class="s2">&quot;4LSTs09MSTs&quot;</span><span class="p">:</span>    <span class="p">{</span><span class="s2">&quot;20deg&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span><span class="p">,</span>
                               <span class="s2">&quot;40deg&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span><span class="p">,</span>
                               <span class="s2">&quot;60deg&quot;</span><span class="p">:</span> <span class="mi">110</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span>
                              <span class="p">},</span>
             <span class="s2">&quot;LST&quot;</span>       <span class="p">:</span>    <span class="p">{</span><span class="s2">&quot;20deg&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span><span class="p">,</span>
                               <span class="s2">&quot;40deg&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span><span class="p">,</span>
                               <span class="s2">&quot;60deg&quot;</span><span class="p">:</span> <span class="mi">110</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span>
                              <span class="p">},</span>
             <span class="s2">&quot;MST&quot;</span>       <span class="p">:</span>    <span class="p">{</span><span class="s2">&quot;20deg&quot;</span><span class="p">:</span> <span class="mi">110</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span><span class="p">,</span>
                               <span class="s2">&quot;40deg&quot;</span><span class="p">:</span> <span class="mi">110</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span><span class="p">,</span>
                               <span class="s2">&quot;60deg&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span>
                              <span class="p">},</span>             
             <span class="s2">&quot;14MSTs37SSTs&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;20deg&quot;</span><span class="p">:</span> <span class="mi">110</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span><span class="p">,</span>
                               <span class="s2">&quot;40deg&quot;</span><span class="p">:</span> <span class="mi">110</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span><span class="p">,</span>
                               <span class="s2">&quot;60deg&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="o">-</span><span class="n">safe_margin</span>
                              <span class="p">}</span>
            <span class="p">}</span>

<span class="n">erec_max</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;20deg&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">TeV</span> <span class="o">+</span> <span class="n">safe_margin</span><span class="p">,</span>
            <span class="s2">&quot;40deg&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">TeV</span> <span class="o">+</span> <span class="n">safe_margin</span><span class="p">,</span>
            <span class="s2">&quot;60deg&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">TeV</span> <span class="o">+</span> <span class="n">safe_margin</span><span class="p">}</span>

<span class="n">etrue_max</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;20deg&quot;</span><span class="p">:</span> <span class="mi">17</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
             <span class="s2">&quot;40deg&quot;</span><span class="p">:</span> <span class="mi">17</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
             <span class="s2">&quot;60deg&quot;</span><span class="p">:</span> <span class="mi">17</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">}</span>

<span class="n">nbin_per_decade</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c1"># This &quot;optimal&quot; spacing was generated by hand from the output of the function</span>
<span class="c1"># below (generate_E_edges).</span>
<span class="c1"># It ensures that the critical IRF thresholds are in the list for</span>
<span class="c1"># an efficient masking</span>

<span class="c1"># Warning: an axis starting below the min generated energy creates problem</span>
<span class="c1"># in the background evaluation</span>
<span class="c1"># I have removed the 1.00000000e+01 GeV edge, and even start at the minimum</span>
<span class="c1"># authorised energy (low zenith)</span>

<span class="n">erec_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">3.00000000e+01</span><span class="p">,</span> <span class="c1"># LST 20°</span>
                        <span class="c1">#3.16227766e+01, # too close fro previous edge</span>
                        <span class="mf">4.00000000e+01</span><span class="p">,</span> <span class="c1"># LST 40°</span>
                        <span class="mf">5.62341325e+01</span><span class="p">,</span>
                        <span class="c1">#1.00000000e+02, # too close from next edge</span>
                        <span class="mf">1.10000000e+02</span><span class="p">,</span> <span class="c1"># LST 60, MST 20° and 40°</span>
                        <span class="c1"># 1.77827941e+02,  # too close from next edge</span>
                        <span class="mf">2.0e+02</span><span class="p">,</span> <span class="c1"># too close from next edge</span>
                        <span class="c1">#2.5e+02, # MST 60°</span>
                        <span class="mf">3.16227766e+02</span><span class="p">,</span>
                        <span class="mf">5.62341325e+02</span><span class="p">,</span>
                        <span class="mf">1.00000000e+03</span><span class="p">,</span>
                        <span class="mf">1.77827941e+03</span><span class="p">,</span>
                        <span class="mf">3.16227766e+03</span><span class="p">,</span>
                        <span class="mf">5.62341325e+03</span><span class="p">,</span>
                        <span class="mf">1.00000000e+04</span><span class="p">,</span>
                        <span class="mf">1.5e+04</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span>

<span class="c1"># Denser</span>
<span class="c1"># erec_edges = np.asarray([ 30.,</span>
<span class="c1">#                           37.0,       </span>
<span class="c1">#                           40.33143141,</span>
<span class="c1">#                           47.0,</span>
<span class="c1">#                           54.22081198,</span>
<span class="c1">#                           65.0,</span>
<span class="c1">#                           72.89343197,</span>
<span class="c1">#                           110.,</span>
<span class="c1">#    131.74470232,   177.11508083,   250,  </span>
<span class="c1">#                         3.16227766e+02,</span>
<span class="c1">#                         5.62341325e+02,</span>
<span class="c1">#                         1.00000000e+03,</span>
<span class="c1">#                         1.77827941e+03,</span>
<span class="c1">#                         3.16227766e+03,</span>
<span class="c1">#                         5.62341325e+03,</span>
<span class="c1">#                         1.00000000e+04,</span>
<span class="c1">#                         1.5e+04])*u.GeV</span>




<span class="n">__all__</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;IRF&#39;</span><span class="p">]</span>

<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="IRF"><a class="viewcode-back" href="../api/irf.IRF.html#irf.IRF">[docs]</a><span class="k">class</span> <span class="nc">IRF</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class handles the Instrument response function information and</span>
<span class="sd">    utilities</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">###------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">irf</span>       <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">subarray</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">ereco</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">etrue</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">ereco_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">ereco_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise the object.</span>
<span class="sd">        Compute the ratio (factor) of the surface between the default on-region</span>
<span class="sd">        and the 68% containment region.</span>
<span class="sd">        This factor will be used in the dataset creation to renormalize the</span>
<span class="sd">        background to the 68% containment of the effective area.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : String, optional</span>
<span class="sd">            The IRF file name on disk. The default is &quot;none&quot;.</span>
<span class="sd">        irf : TYPE, optional</span>
<span class="sd">            DESCRIPTION. The default is None.</span>
<span class="sd">        array : String</span>
<span class="sd">            The array configuration. default is None</span>
<span class="sd">        ereco : TYPE, optional</span>
<span class="sd">            DESCRIPTION. The default is None.</span>
<span class="sd">        etrue : TYPE, optional</span>
<span class="sd">            DESCRIPTION. The default is None.</span>
<span class="sd">        ereco_min : TYPE, optional</span>
<span class="sd">            DESCRIPTION. The default is None.</span>
<span class="sd">        ereco_max : TYPE, optional</span>
<span class="sd">            DESCRIPTION. The default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        Todo</span>
<span class="sd">        ----</span>
<span class="sd">        So far, all IRF have the same Ereco axes, since it is required for</span>
<span class="sd">        further stacking. As a consequence this axis could be mutualised</span>


<span class="sd">        The PSF being given versus true energy, using the reconstructed energy</span>
<span class="sd">        axis to compute the factor assumes that the reconstructed energy is</span>
<span class="sd">        strictly equals to the true energy, which is certainly not the case at</span>
<span class="sd">        the lowest energies.</span>
<span class="sd">        Maybe this could desserve a specific study.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>  <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irf</span>       <span class="o">=</span> <span class="n">irf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subarray</span>  <span class="o">=</span> <span class="n">subarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ereco</span>     <span class="o">=</span> <span class="n">ereco</span> <span class="c1"># The same for everybody in order to stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etrue</span>     <span class="o">=</span> <span class="n">etrue</span> <span class="c1"># idem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ereco_min</span> <span class="o">=</span> <span class="n">ereco_min</span> <span class="c1"># For further masking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ereco_max</span> <span class="o">=</span> <span class="n">ereco_max</span> <span class="c1"># For further masking</span>

        <span class="n">erec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ereco</span><span class="o">.</span><span class="n">center</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">irf</span><span class="p">[</span><span class="s1">&#39;psf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">containment_radius</span><span class="p">(</span><span class="n">energy</span>   <span class="o">=</span> <span class="n">erec</span><span class="p">,</span>
                                              <span class="n">theta</span>    <span class="o">=</span> <span class="n">mcf</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="n">subarray</span><span class="p">],</span>
                                              <span class="n">fraction</span> <span class="o">=</span> <span class="n">mcf</span><span class="o">.</span><span class="n">containment</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">f</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">radii</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">mcf</span><span class="o">.</span><span class="n">on_size</span><span class="p">[</span><span class="n">subarray</span><span class="p">]))</span>
        <span class="c1"># If factor is too large above threshold, error</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">erec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">f</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ereco_min</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">idx</span><span class="p">)):</span>
            <span class="c1"># Get guilty energies</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; E = &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ereco</span><span class="o">.</span><span class="n">center</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; R = &quot;</span><span class="p">,</span><span class="n">radii</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="s2">&quot; max = &quot;</span><span class="p">,</span>
                          <span class="n">mcf</span><span class="o">.</span><span class="n">on_size</span><span class="p">[</span><span class="n">array</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; F = &quot;</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="c1">#sys.exit(&quot;IRF : Initial region too small&quot;)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="n">f</span>

        <span class="k">return</span>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="IRF.find_best_keys"><a class="viewcode-back" href="../api/irf.IRF.html#irf.IRF.find_best_keys">[docs]</a>    <span class="k">def</span> <span class="nf">find_best_keys</span><span class="p">(</span><span class="n">zenith</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">obstime</span><span class="p">,</span>
                       <span class="n">closest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fixed_zenith</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prod</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the best keys to later identify the IRF data file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        zenith : Quantity, angle</span>
<span class="sd">            zenith angle.</span>
<span class="sd">        azimuth : Quantity, angle</span>
<span class="sd">            Azimuth angle.</span>
<span class="sd">        obstime : Quantity, time</span>
<span class="sd">            Observation duration.</span>
<span class="sd">        closest : Boolean, optional</span>
<span class="sd">            If True, obtain zenith and observation time from the closest</span>
<span class="sd">            available sampling, instead of using the predefined validity value.</span>
<span class="sd">            The default is False.</span>
<span class="sd">        fixed_zenith : Quantity angle, optional</span>
<span class="sd">            If defined, the zenith is fixed at the given value, wathever the</span>
<span class="sd">            observation (for tests). The default is None.</span>
<span class="sd">        prod: S</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        String, String, String</span>
<span class="sd">            The three strings defining the IRF file and/or folder.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">###--------------------------</span>
        <span class="k">def</span> <span class="nf">find_closest_key</span><span class="p">(</span><span class="n">mydict</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
            <span class="n">dict_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mydict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">])</span>
            <span class="n">closest_val</span> <span class="o">=</span> <span class="n">dict_values</span> <span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dict_values</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="p">]</span>
            <span class="n">closest_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mydict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">closest_val</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">closest_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">###--------------------------</span>

        <span class="c1"># Zenith</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">closest</span><span class="p">):</span>
            <span class="n">kzen</span> <span class="o">=</span> <span class="n">find_closest_key</span><span class="p">(</span><span class="n">zenith_list</span><span class="p">,</span> <span class="n">zenith</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">zenith_valid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">zenith</span> <span class="o">&gt;=</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">zenith</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">):</span>
                    <span class="n">kzen</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">found</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;get_irf_file: zenith= </span><span class="si">{}</span><span class="s2"> =&gt; range not found&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">zenith</span><span class="p">))</span>

        <span class="c1"># Azimuth - implement here N, S choice</span>
        <span class="n">kaz</span> <span class="o">=</span> <span class="s2">&quot;average&quot;</span>

        <span class="c1"># Observation time</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">closest</span><span class="p">):</span>
            <span class="n">kdt</span> <span class="o">=</span><span class="n">find_closest_key</span><span class="p">(</span><span class="n">dt_list</span><span class="p">[</span><span class="n">prod</span><span class="p">],</span> <span class="n">obstime</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dt_log_valid</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">obstime</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
                   <span class="ow">and</span> <span class="n">obstime</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span>
                    <span class="n">kdt</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">found</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;get_irf_file: obstime range not found&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">kzen</span><span class="p">,</span> <span class="n">kaz</span><span class="p">,</span> <span class="n">kdt</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="IRF.from_observation"><a class="viewcode-back" href="../api/irf.IRF.html#irf.IRF.from_observation">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_observation</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                         <span class="n">zenith</span>   <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                         <span class="n">azimuth</span>  <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                         <span class="n">obstime</span>  <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">h</span><span class="p">,</span>
                         <span class="n">subarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">loc</span>      <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">nsb</span>      <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">irf_dir</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">closest</span>  <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">debug</span>    <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the IRF data from the chaarcteristics of an observation.</span>
<span class="sd">        Note that MapAxis accepts ony a normalised list of axis type as</span>
<span class="sd">        described `here &lt;https://docs.gammapy.org/dev/irf/index.html#irf-axis-naming&gt;`_.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cls : IRF class instance</span>
<span class="sd">            Current object.</span>
<span class="sd">        zenith : Quantity angle, optional</span>
<span class="sd">            Observation zenith angle. The default is 0*u.deg.</span>
<span class="sd">        azimuth : Quantity angle, optional</span>
<span class="sd">            Observation azimuth angle. The default is 0*u.deg.</span>
<span class="sd">        obstime : Quantity time, optional</span>
<span class="sd">            Observation time. The default is 0*u.h.</span>
<span class="sd">        kchain : String, optional</span>
<span class="sd">            IRF version folder. The default is &quot;prod3-v2&quot;.</span>
<span class="sd">        array : String, optional</span>
<span class="sd">            Sub-array folder name. The default is &quot;FullArray&quot;.</span>
<span class="sd">        loc : String, optional</span>
<span class="sd">            Site location. The default is None.</span>
<span class="sd">        nsb : TYPE, optional</span>
<span class="sd">            Handle special NSB cases. The default is None.</span>
<span class="sd">        irf_dir : string, optional</span>
<span class="sd">            IRF folder. The default is None.</span>
<span class="sd">        closest : Boolean, optional</span>
<span class="sd">            Choose IRF closes to IRF range bounds. The default is False.</span>
<span class="sd">        debug : Boolean, optional</span>
<span class="sd">            If True, verbose mode. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        IRF ojbect</span>
<span class="sd">            Initialise an IRF object with the obtained values.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;from_observation : location should be defined&quot;</span><span class="p">)</span>

        <span class="c1"># Find best keys (IRF interpolation)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">irf_dir</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;prod&quot;</span><span class="p">)</span>
        <span class="n">prod</span> <span class="o">=</span> <span class="n">irf_dir</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">kzen</span><span class="p">,</span> <span class="n">kaz</span><span class="p">,</span> <span class="n">kdt</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">find_best_keys</span><span class="p">(</span><span class="n">zenith</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">obstime</span><span class="p">,</span>
                                                <span class="n">closest</span> <span class="o">=</span> <span class="n">closest</span><span class="p">,</span>
                                                <span class="n">prod</span><span class="o">=</span><span class="n">prod</span><span class="p">)</span>
            
        <span class="c1"># Find base folder from the keys</span>
        <span class="k">if</span> <span class="n">prod</span><span class="o">==</span><span class="s2">&quot;prod3&quot;</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">irf_dir</span><span class="p">,</span><span class="n">subarray</span><span class="p">,</span><span class="n">loc</span><span class="p">,</span><span class="n">kzen</span><span class="p">)</span>
                    <span class="c1"># Build the filename, get the IRF</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">subarray</span> <span class="o">!=</span> <span class="s2">&quot;FullArray&quot;</span><span class="p">):</span>
                <span class="n">kaz</span> <span class="o">=</span> <span class="n">kaz</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">subarray</span>
            <span class="n">subfolder</span> <span class="o">=</span> <span class="n">loc</span><span class="o">+</span><span class="s2">&quot;_z&quot;</span><span class="o">+</span><span class="n">kzen</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">kaz</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">kdt</span>
            <span class="n">irf_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="n">subfolder</span><span class="p">,</span><span class="s2">&quot;irf_file.fits.gz&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">prod</span><span class="o">==</span><span class="s2">&quot;prod5&quot;</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">irf_dir</span><span class="p">,</span><span class="n">subarray</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kaz</span><span class="o">==</span><span class="s2">&quot;average&quot;</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;Prod5-&quot;</span><span class="o">+</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">kzen</span><span class="o">+</span><span class="s2">&quot;-AverageAz-&quot;</span>\
                    <span class="o">+</span><span class="n">subarray</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">kdt</span><span class="o">+</span><span class="s2">&quot;-v0.1.fits.gz&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Azimuth, only average is implemented&quot;</span><span class="p">)</span>
                
            <span class="n">irf_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="p">;</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>

        <span class="n">irf</span> <span class="o">=</span> <span class="n">load_cta_irfs</span><span class="p">(</span><span class="n">irf_file</span><span class="p">)</span>

        <span class="c1"># True energy axis</span>
        <span class="kn">import</span> <span class="nn">gammapy</span>
        <span class="k">if</span> <span class="n">gammapy</span><span class="o">.</span><span class="n">__version__</span> <span class="o">==</span> <span class="s2">&quot;0.17&quot;</span><span class="p">:</span>
            <span class="n">eirf_min</span>    <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">irf</span><span class="p">[</span><span class="s2">&quot;aeff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;energy_true&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># 0.18.2</span>
            <span class="n">eirf_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">irf</span><span class="p">[</span><span class="s2">&quot;aeff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="s2">&quot;energy_true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
                
        <span class="n">etrue_axis</span>  <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_energy_bounds</span><span class="p">(</span><span class="n">eirf_min</span><span class="p">,</span>
                                                 <span class="n">etrue_max</span><span class="p">[</span><span class="n">kzen</span><span class="p">],</span>
                                                 <span class="n">nbin</span> <span class="o">=</span> <span class="n">nbin_per_decade</span><span class="p">,</span>
                                                 <span class="n">per_decade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                 <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy_true&quot;</span><span class="p">)</span>

        <span class="c1"># Reconstructed energy axis</span>
        <span class="c1"># Stacking requires same original binning -&gt; uses largest interval</span>
        <span class="c1"># Ensure that all possible edges are in, later apply masking</span>
        <span class="c1"># Use the Optimised binning</span>
        <span class="c1"># There is a bug in 0.17 (unit not taken into account</span>
        <span class="c1"># correctly)preventig from simply writing</span>
        <span class="c1"># erec_axis = MapAxis.from_edges(erec_edges,name=&quot;energy&quot;)</span>

        <span class="n">erec_axis</span> <span class="o">=</span> <span class="n">MapAxis</span><span class="o">.</span><span class="n">from_edges</span><span class="p">(</span><span class="n">erec_edges</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;TeV&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                       <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;TeV&quot;</span><span class="p">,</span>
                                       <span class="n">name</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span>
                                       <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

        <span class="c1"># Alternatively, this is not optimal for masking except if the</span>
        <span class="c1"># number of bins is very large:</span>
        <span class="c1"># erec_axis  = MapAxis.from_energy_bounds(min(erec_min.values()),</span>
        <span class="c1">#                                         max(erec_max.values()),</span>
        <span class="c1">#                                         nbin = nbin_per_decade,</span>
        <span class="c1">#                                         per_decade=True,</span>
        <span class="c1">#                                         name=&quot;Rec. energy&quot;)</span>

        <span class="c1"># This leads to</span>
        <span class="c1"># OSError: [WinError 1251] Cette opération n’est prise en charge que</span>
        <span class="c1"># lorsque vous êtes connecté au serveur:</span>
        <span class="c1"># if (irf_file.exists() != True):</span>
        <span class="c1">#     sys.exit(&quot; This file does not exist :&quot;,irf_file)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">filename</span>  <span class="o">=</span> <span class="n">irf_file</span><span class="p">,</span>
                   <span class="n">irf</span>       <span class="o">=</span> <span class="n">irf</span><span class="p">,</span>
                   <span class="n">subarray</span>  <span class="o">=</span> <span class="n">subarray</span><span class="p">,</span>
                   <span class="n">etrue</span>     <span class="o">=</span> <span class="n">etrue_axis</span><span class="p">,</span>
                   <span class="n">ereco</span>     <span class="o">=</span> <span class="n">erec_axis</span><span class="p">,</span>
                   <span class="n">ereco_min</span> <span class="o">=</span> <span class="n">erec_min</span><span class="p">[</span><span class="n">subarray</span><span class="p">][</span><span class="n">kzen</span><span class="p">],</span>
                   <span class="n">ereco_max</span> <span class="o">=</span> <span class="n">erec_max</span><span class="p">[</span><span class="n">kzen</span><span class="p">])</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="IRF.containment_plot"><a class="viewcode-back" href="../api/irf.IRF.html#irf.IRF.containment_plot">[docs]</a>    <span class="k">def</span> <span class="nf">containment_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">eunit</span><span class="o">=</span><span class="s2">&quot;GeV&quot;</span><span class="p">,</span><span class="n">subarray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-poster&#39;</span><span class="p">)</span> <span class="c1"># Bug with normal x marker !!!</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># irfname =  self.filename.parts[-2]</span>

        <span class="n">radii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">irf</span><span class="p">[</span><span class="s1">&#39;psf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">containment_radius</span><span class="p">(</span><span class="n">energy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ereco</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>
                                                 <span class="n">theta</span> <span class="o">=</span> <span class="n">mcf</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="n">subarray</span><span class="p">],</span>
                                                 <span class="n">fraction</span><span class="o">=</span><span class="n">mcf</span><span class="o">.</span><span class="n">containment</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ereco</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">eunit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">radii</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span> <span class="n">tag</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ereco_min</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">eunit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ereco_max</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">eunit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy (&quot;</span><span class="o">+</span><span class="n">eunit</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Containment radius (°)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">return</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="IRF.print"><a class="viewcode-back" href="../api/irf.IRF.html#irf.IRF.print">[docs]</a>    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print out some IRF class contents</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IRF             : &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Etrue          : &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">etrue</span><span class="p">)</span>  <span class="c1"># E reco axis</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;          edges : &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">etrue</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Ereco          : &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ereco</span><span class="p">)</span>  <span class="c1"># E true axis</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;          edges : &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ereco</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Erec min (irf) : &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ereco_min</span><span class="p">)</span> <span class="c1"># IRF lower E validity</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Erec max (irf) : &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ereco_max</span><span class="p">)</span> <span class="c1"># IRF upper E validity</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Cont. factor   : &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="k">return</span></div></div>

<span class="c1">###############################################################################</span>
<span class="c1">### Utilities and check plots</span>
<span class="c1">###############################################################################</span>
<span class="k">def</span> <span class="nf">generate_E_edges</span><span class="p">(</span><span class="n">E1</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span> <span class="n">E2</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
                     <span class="n">subarray</span><span class="o">=</span><span class="s2">&quot;FullArray&quot;</span><span class="p">,</span><span class="n">nperdecade</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate energy edges including the reconstructed energy thresholds.</span>
<span class="sd">    Just copy tthe output to the code and rearrange the values to remove too</span>
<span class="sd">    too narrow bins.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    E1 : Quantity, optional</span>
<span class="sd">        Lower bound. The default is 10*u.GeV.</span>
<span class="sd">    E2 : Quantity, optional</span>
<span class="sd">        Upper bound. The default is 100*u.TeV.</span>
<span class="sd">    nperdecade : Integer, optional</span>
<span class="sd">        Default number of bins per decade. The default is 4.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unit_ref</span> <span class="o">=</span> <span class="n">E1</span><span class="o">.</span><span class="n">unit</span>
    <span class="n">Emin</span> <span class="o">=</span> <span class="n">E1</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit_ref</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="n">Emax</span> <span class="o">=</span> <span class="n">E2</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit_ref</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

    <span class="c1"># Compute the number of bins to be generated from the number of decades</span>
    <span class="n">ndecade</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Emax</span><span class="o">/</span><span class="n">Emin</span><span class="p">)</span> <span class="c1"># Number of decades covered</span>
    <span class="n">nbin</span> <span class="o">=</span> <span class="n">ndecade</span><span class="o">*</span><span class="n">nperdecade</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total number of bins =&quot;</span><span class="p">,</span><span class="n">nbin</span><span class="p">)</span>
    <span class="n">e_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Emin</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Emax</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">nbin</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">unit_ref</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial edging :&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e_edges</span><span class="p">)</span>

    <span class="c1"># Add critical values to the array</span>
    <span class="n">e_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e_edges</span><span class="p">,</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit_ref</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">erec_min</span><span class="p">[</span><span class="n">subarray</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">e_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e_edges</span><span class="p">,</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit_ref</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">erec_max</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">e_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">e_edges</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final edging - indicative (copy this and rearrange if needed):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e_edges</span><span class="p">)</span>

    <span class="k">return</span>

<span class="c1">###------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">onoff_sketch_plot</span><span class="p">(</span><span class="n">irf</span><span class="p">,</span><span class="n">Emin</span><span class="o">=</span><span class="mi">30</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span><span class="n">subarray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">nmaxcol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    On-off geometry skeches as a function of reconstrcuted energy edges</span>
<span class="sd">    for the current IRF</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    eunit : String, optional</span>
<span class="sd">        Energy unit used. The default is &quot;GeV&quot;.</span>
<span class="sd">    debug : Boolean, optional</span>
<span class="sd">        Let&#39;s&#39; say a word on what is done. The default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-poster&#39;</span><span class="p">)</span> <span class="c1"># Bug with normal x marker !!!</span>

    <span class="c1"># Retrieve radii at EDGES</span>
    <span class="c1"># Assumes that Erec = Etrue as the PSF is given versus Etrue</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="n">irf</span><span class="o">.</span><span class="n">irf</span><span class="p">[</span><span class="s1">&#39;psf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">containment_radius</span><span class="p">(</span><span class="n">energy</span>    <span class="o">=</span> <span class="n">irf</span><span class="o">.</span><span class="n">ereco</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>
                                               <span class="n">theta</span>    <span class="o">=</span> <span class="n">mcf</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="n">subarray</span><span class="p">],</span>
                                               <span class="n">fraction</span> <span class="o">=</span> <span class="n">mcf</span><span class="o">.</span><span class="n">containment</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="mi">72</span><span class="o">*</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">radii</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="c1">###-----------------------------</span>
    <span class="k">def</span> <span class="nf">onoffsketch</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span><span class="n">energy</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the on-off sketch n the field of view from a containment</span>
<span class="sd">        radius at a given energy (used for labelling only)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ax</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="c1"># On region</span>
        <span class="n">x_on</span> <span class="o">=</span> <span class="n">mcf</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="n">subarray</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">y_on</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Default on region (useless)</span>
        <span class="n">on_reg</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span> <span class="p">(</span><span class="n">x_on</span><span class="p">,</span> <span class="n">y_on</span><span class="p">),</span> <span class="n">mcf</span><span class="o">.</span><span class="n">on_size</span><span class="p">[</span><span class="n">subarray</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="p">,</span>
                             <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="c1"># 68% Aeff contained region</span>
        <span class="n">on68</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span> <span class="p">(</span><span class="n">x_on</span><span class="p">,</span><span class="n">y_on</span><span class="p">),</span> <span class="n">radius</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="c1"># ax.text(x_on,y_on,s=&quot;on&quot;)</span>

        <span class="c1"># Build label</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span> <span class="n">energy</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Emin</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">+=</span> <span class="s2">&quot; - &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">mcf</span><span class="o">.</span><span class="n">containment</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;%&quot;</span>
        <span class="c1"># ax.set_title(&#39;Field of view -&#39;+txt )</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span> <span class="n">on_reg</span> <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span> <span class="n">on68</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">on68</span><span class="p">],</span> <span class="p">[</span><span class="n">txt</span><span class="p">]</span> <span class="p">)</span>

        <span class="c1"># Equal acceptance circle</span>
        <span class="n">accept</span> <span class="o">=</span>  <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">mcf</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="n">subarray</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="p">,</span>
                            <span class="n">fill</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span> <span class="n">accept</span> <span class="p">)</span>

        <span class="c1"># Off regions</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noff_reg</span><span class="p">):</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">dtheta</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_on</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">x_on</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">off_reg</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="p">),</span> <span class="n">radius</span><span class="o">.</span><span class="n">value</span> <span class="p">,</span>
                                 <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span> <span class="n">off_reg</span> <span class="p">)</span>

        <span class="c1"># Mark center of FOV</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

        <span class="c1"># Set field of view, and aspect ratio</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">mcf</span><span class="o">.</span><span class="n">fov</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="n">view</span><span class="p">,</span><span class="n">view</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="n">view</span><span class="p">,</span><span class="n">view</span><span class="p">])</span>
        <span class="c1"># ax.set_aspect( 1 ) # Nice but conflicts with grid spacing</span>

        <span class="k">return</span>
    <span class="c1">###-----------------------------</span>

    <span class="n">noff_reg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">mcf</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">dtheta</span>   <span class="o">=</span> <span class="mi">360</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="o">/</span><span class="n">noff_reg</span>
    <span class="c1">#print(noff_reg,&quot; regions separated by &quot;, dtheta)</span>

    <span class="n">xsize</span>    <span class="o">=</span> <span class="mi">4</span>
    <span class="n">ysize</span>    <span class="o">=</span> <span class="mi">4</span>
    <span class="n">nplots</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">irf</span><span class="o">.</span><span class="n">ereco</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">irf</span><span class="o">.</span><span class="n">ereco</span><span class="o">.</span><span class="n">edges</span><span class="o">&gt;=</span><span class="n">Emin</span><span class="p">])</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">#</span>
    <span class="n">ifirst</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">irf</span><span class="o">.</span><span class="n">ereco</span><span class="o">.</span><span class="n">edges</span><span class="o">&gt;=</span><span class="n">Emin</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ncols</span>    <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nmaxcol</span><span class="p">,</span><span class="n">nplots</span><span class="p">)</span> <span class="c1"># If nplots &lt; nmaxcol, take nplots</span>
    <span class="n">nrows</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nplots</span><span class="o">/</span><span class="n">ncols</span><span class="p">)</span><span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">nplots</span><span class="o">%</span><span class="n">ncols</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span>
                           <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">xsize</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="n">ysize</span><span class="o">*</span><span class="n">nrows</span><span class="p">),</span>
                           <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">irf</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">tag</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

    <span class="n">iplot</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kn">import</span> <span class="nn">itertools</span>

    <span class="k">for</span> <span class="n">jrow</span><span class="p">,</span> <span class="n">icol</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">)):</span>

        <span class="n">ax0</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">jrow</span><span class="p">][</span><span class="n">icol</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">nrows</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">ax</span><span class="p">[</span><span class="n">icol</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">iplot</span> <span class="o">&lt;</span> <span class="n">nplots</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">iplot</span><span class="o">+</span><span class="n">ifirst</span><span class="p">]</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">irf</span><span class="o">.</span><span class="n">ereco</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">iplot</span><span class="o">+</span><span class="n">ifirst</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">Emin</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
            <span class="n">onoffsketch</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span><span class="n">energy</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="k">continue</span> <span class="c1"># Next plot</span>

        <span class="c1"># Compactify</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">jrow</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">nrows</span><span class="p">):</span> <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">icol</span> <span class="o">!=</span><span class="mi">0</span><span class="p">):</span> <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">)</span>

        <span class="n">iplot</span><span class="o">+=</span><span class="mi">1</span>

    <span class="c1"># know feature/bug : does not take supttile into account !</span>
    <span class="c1"># fig.suptitle(&quot;Title centered above all subplots&quot;, fontsize=14)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">h_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">w_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Adjsut AFTER tight_layout</span>
    <span class="c1">#plt.subplots_adjust(top=0.4,hspace=None,wspace=None)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

    <span class="k">return</span>

<span class="c1">###------------------------------------------------------------------------</span>
<span class="k">def</span>  <span class="nf">aeff_plot</span><span class="p">(</span><span class="n">irf</span><span class="p">,</span><span class="n">min_fraction</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;GeV&quot;</span><span class="p">):</span>

    <span class="c1"># Effective area</span>
    <span class="n">effarea</span> <span class="o">=</span> <span class="n">irf</span><span class="o">.</span><span class="n">irf</span><span class="p">[</span><span class="s2">&quot;aeff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">e_edges</span> <span class="o">=</span> <span class="n">effarea</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">center</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">off</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">]):</span>
        <span class="n">axij</span> <span class="o">=</span> <span class="n">axi</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">effoff</span> <span class="o">=</span> <span class="n">irf</span><span class="o">.</span><span class="n">irf</span><span class="p">[</span><span class="s2">&quot;aeff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_effective_area_table</span><span class="p">(</span><span class="n">off</span><span class="p">)</span>
        <span class="n">effmax</span> <span class="o">=</span> <span class="n">effoff</span><span class="o">.</span><span class="n">max_area</span> <span class="c1"># or max( effarea.evaluate(energy_true=e_edges,offset=off) )</span>
        <span class="n">e10</span>    <span class="o">=</span> <span class="n">effoff</span><span class="o">.</span><span class="n">find_energy</span><span class="p">(</span><span class="n">effmax</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{:6.2f}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e10</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">off</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">off</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span><span class="n">irf</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="c1"># effarea.evaluate(energy_true = e_edges,offset =off))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">axij</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e_edges</span><span class="p">,</span>
                          <span class="n">effoff</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">energy_true</span> <span class="o">=</span> <span class="n">e_edges</span><span class="p">),</span>
                          <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="n">axij</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">min_fraction</span><span class="o">*</span><span class="n">effmax</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>
            <span class="c1"># axij.axvline(x=irf.ereco_min,</span>
            <span class="c1">#              ls=&quot;:&quot;,color=p[0].get_color(),</span>
            <span class="c1">#              label=&quot;Emin&quot;)</span>
            <span class="c1"># axij.axvline(x=irf.ereco_max,</span>
            <span class="c1">#              ls=&quot;:&quot;,color=p[0].get_color(),</span>
            <span class="c1">#              label=&quot;Emax&quot;)</span>
            <span class="n">axij</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
            <span class="c1">#axij.set_yscale(&quot;log&quot;)</span>
            <span class="c1">#axij.set_title(str(i)+&quot; &quot;+str(j))</span>
            <span class="n">axij</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">:</span> <span class="n">axij</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">&lt;</span><span class="mi">2</span> <span class="p">:</span> <span class="n">axij</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
            <span class="c1">#axis.legend()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">h_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">return</span>

<span class="c1">###############################################################################</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Code example to use the IRF class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">gammapy</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Running with gammapy &quot;</span><span class="p">,</span><span class="n">gammapy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>

    <span class="c1"># irf_dir = &quot;../input/irf/OnAxis/&quot;</span>
    <span class="n">irf_dir</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;D:\CTA\00-Data\IRF-SoHAPPy\prod3-v2&quot;</span>
    <span class="n">array</span>   <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;North&quot;</span><span class="p">:</span><span class="s2">&quot;FullArray&quot;</span><span class="p">,</span> <span class="s2">&quot;South&quot;</span><span class="p">:</span><span class="s2">&quot;FullArray&quot;</span><span class="p">}</span> <span class="c1"># &quot;FullArray&quot;, &quot;LST&quot;,...</span>
    <span class="c1">#array   = {&quot;North&quot;:&quot;MST&quot;, &quot;South&quot;:&quot;MST&quot;} # &quot;FullArray&quot;, &quot;LST&quot;,...</span>

    <span class="c1"># irf_dir = r&quot;D:\CTA\00-Data\IRF-SoHAPPy\prod5-v0.1&quot;</span>
    <span class="c1"># array   = {&quot;North&quot;:&quot;4LSTs09MSTs&quot;, &quot;South&quot;:&quot;14MSTs37SSTs&quot;}</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">irf_dir</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;prod&quot;</span><span class="p">)</span>
    <span class="n">prod</span> <span class="o">=</span> <span class="n">irf_dir</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Processing &quot;</span><span class="p">,</span><span class="n">prod</span><span class="p">,</span><span class="s2">&quot; files&quot;</span><span class="p">)</span>
    <span class="n">show</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;containment&quot;</span><span class="p">,</span> <span class="s2">&quot;onoff&quot;</span><span class="p">,</span> <span class="s2">&quot;effearea&quot;</span><span class="p">,</span><span class="s2">&quot;generic&quot;</span><span class="p">]</span>
    <span class="n">show</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;containment&quot;</span><span class="p">]</span>
    
    <span class="n">generate_E_edges</span><span class="p">(</span><span class="n">E1</span><span class="o">=</span><span class="mi">30</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span><span class="n">E2</span><span class="o">=</span><span class="mi">15</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span><span class="n">nperdecade</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="c1">###-------------------------</span>
    <span class="c1">### Generic    </span>
    <span class="c1">###-------------------------</span>
    <span class="k">if</span> <span class="s2">&quot;generic&quot;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">,</span><span class="s2">&quot;South&quot;</span><span class="p">]:</span>
            <span class="n">irf</span> <span class="o">=</span> <span class="n">IRF</span><span class="o">.</span><span class="n">from_observation</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span>
                                        <span class="n">subarray</span>   <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">loc</span><span class="p">],</span>
                                        <span class="n">zenith</span>  <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                        <span class="n">azimuth</span> <span class="o">=</span> <span class="mi">123</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                        <span class="n">obstime</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
                                        <span class="n">irf_dir</span> <span class="o">=</span> <span class="n">irf_dir</span> <span class="p">)</span>
            <span class="n">irf</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>
            <span class="n">irf</span><span class="o">.</span><span class="n">irf</span><span class="p">[</span><span class="s2">&quot;psf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
            <span class="n">irf</span><span class="o">.</span><span class="n">irf</span><span class="p">[</span><span class="s2">&quot;edisp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
    
        <span class="nb">print</span><span class="p">(</span><span class="n">dt_log_valid</span><span class="p">)</span>
        <span class="n">generate_E_edges</span><span class="p">()</span> <span class="c1"># &lt;- egenrate optimal edges with this</span>
    
    <span class="c1">###-------------------------</span>
    <span class="c1">### Show containment radii    </span>
    <span class="c1">###-------------------------</span>
    <span class="k">if</span> <span class="s2">&quot;containment&quot;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">,</span><span class="s2">&quot;South&quot;</span><span class="p">]:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">loc</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ztag</span><span class="p">,</span> <span class="n">axi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">zenith_list</span><span class="p">,</span><span class="n">ax</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_list</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>           
                    <span class="n">irf</span> <span class="o">=</span> <span class="n">IRF</span><span class="o">.</span><span class="n">from_observation</span><span class="p">(</span><span class="n">loc</span>       <span class="o">=</span> <span class="n">loc</span><span class="p">,</span>
                                                <span class="n">subarray</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">loc</span><span class="p">],</span>
                                                <span class="n">zenith</span>   <span class="o">=</span> <span class="n">zenith_list</span><span class="p">[</span><span class="n">ztag</span><span class="p">],</span>
                                                <span class="n">azimuth</span>  <span class="o">=</span> <span class="mi">123</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                                <span class="n">obstime</span>  <span class="o">=</span> <span class="n">dt</span><span class="p">,</span>
                                                <span class="n">irf_dir</span>  <span class="o">=</span> <span class="n">irf_dir</span> <span class="p">)</span>    
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----&gt;&quot;</span><span class="p">,</span><span class="n">irf</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>
                    <span class="n">irf</span><span class="o">.</span><span class="n">containment_plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axi</span><span class="p">,</span>
                                         <span class="n">subarray</span><span class="o">=</span><span class="n">array</span><span class="p">[</span><span class="n">loc</span><span class="p">],</span>
                                         <span class="n">tag</span><span class="o">=</span><span class="n">ztag</span><span class="o">+</span><span class="s2">&quot; - &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
            
    <span class="c1">###-------------------------</span>
    <span class="c1">### Show on-off sketch / containment radii</span>
    <span class="c1">###-------------------------   </span>
    <span class="k">if</span> <span class="s2">&quot;onoff&quot;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span> 
        <span class="c1"># for loc in [&quot;North&quot;,&quot;South&quot;]:</span>
        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">,</span><span class="s2">&quot;South&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">ztag</span> <span class="ow">in</span> <span class="n">zenith_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">dt_list</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    
                    <span class="n">irf</span> <span class="o">=</span> <span class="n">IRF</span><span class="o">.</span><span class="n">from_observation</span><span class="p">(</span><span class="n">loc</span>       <span class="o">=</span> <span class="n">loc</span><span class="p">,</span>
                                                <span class="n">subarray</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">loc</span><span class="p">],</span>
                                                <span class="n">zenith</span>   <span class="o">=</span> <span class="n">zenith_list</span><span class="p">[</span><span class="n">ztag</span><span class="p">],</span>
                                                <span class="n">azimuth</span>  <span class="o">=</span> <span class="mi">123</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                                <span class="n">obstime</span>  <span class="o">=</span> <span class="n">dt</span><span class="p">,</span>
                                                <span class="n">irf_dir</span>  <span class="o">=</span> <span class="n">irf_dir</span> <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----&gt;&quot;</span><span class="p">,</span><span class="n">irf</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">Emin</span> <span class="o">=</span> <span class="n">erec_min</span><span class="p">[</span><span class="n">array</span><span class="p">[</span><span class="n">loc</span><span class="p">]][</span><span class="n">ztag</span><span class="p">]</span>
                    <span class="n">onoff_sketch_plot</span><span class="p">(</span><span class="n">irf</span><span class="p">,</span><span class="n">Emin</span><span class="o">=</span><span class="n">Emin</span><span class="p">,</span><span class="n">nmaxcol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                      <span class="n">subarray</span><span class="o">=</span><span class="n">array</span><span class="p">[</span><span class="n">loc</span><span class="p">],</span>
                                      <span class="n">tag</span><span class="o">=</span><span class="s2">&quot; - &quot;</span><span class="o">+</span><span class="n">ztag</span><span class="o">+</span><span class="s2">&quot;° - &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span>
               
                    <span class="n">irf</span><span class="o">.</span><span class="n">containment_plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axi</span><span class="p">,</span><span class="n">subarray</span><span class="o">=</span><span class="n">array</span><span class="p">[</span><span class="n">loc</span><span class="p">])</span>
                        
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1">###-------------------------</span>
    <span class="c1">### Effectiva area plots    </span>
    <span class="c1">###-------------------------</span>
    <span class="k">if</span> <span class="s2">&quot;effarea&quot;</span> <span class="ow">in</span> <span class="n">show</span><span class="p">:</span> 
        <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;GeV&quot;</span>
        <span class="n">min_fraction</span> <span class="o">=</span> <span class="mf">0.05</span>
    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; *** Threshold for </span><span class="si">{:2.0f}% e</span><span class="s2">ff.max (</span><span class="si">{:3s}</span><span class="s2">)  *** &quot;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">min_fraction</span><span class="p">,</span><span class="n">unit</span><span class="p">))</span>
    
        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">,</span><span class="s2">&quot;South&quot;</span><span class="p">]:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span>
                                        <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">loc</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:5s}</span><span class="s2"> </span><span class="si">{:10s}</span><span class="s2"> </span><span class="si">{:7s}</span><span class="s2"> </span><span class="si">{:7s}</span><span class="s2"> </span><span class="si">{:7s}</span><span class="s2">&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span><span class="n">array</span><span class="p">[</span><span class="n">loc</span><span class="p">],</span><span class="s2">&quot;0°&quot;</span><span class="p">,</span><span class="s2">&quot;0.5°&quot;</span><span class="p">,</span><span class="s2">&quot;1.0°&quot;</span><span class="p">))</span>
    
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">axi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span><span class="mi">57</span><span class="p">],</span><span class="n">ax</span><span class="p">):</span>
        <span class="c1">#       print(axi)</span>
                <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">100</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span><span class="mf">0.5</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">h</span><span class="p">]:</span>
                    <span class="n">irf</span> <span class="o">=</span> <span class="n">IRF</span><span class="o">.</span><span class="n">from_observation</span><span class="p">(</span><span class="n">loc</span>      <span class="o">=</span> <span class="n">loc</span><span class="p">,</span>
                                                <span class="n">subarray</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">loc</span><span class="p">],</span>
                                                <span class="n">zenith</span>   <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                                <span class="n">azimuth</span>  <span class="o">=</span> <span class="mi">123</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                                <span class="n">obstime</span>  <span class="o">=</span> <span class="n">dt</span><span class="p">,</span>
                                                <span class="n">irf_dir</span>  <span class="o">=</span> <span class="n">irf_dir</span> <span class="p">)</span>
                    <span class="c1">#print(&quot; Found : &quot;,irf.filename)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:13s}</span><span class="s2"> :&quot;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;° &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">unit</span><span class="p">)),</span><span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    
                    <span class="n">aeff_plot</span><span class="p">(</span><span class="n">irf</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span><span class="n">min_fraction</span><span class="o">=</span><span class="n">min_fraction</span><span class="p">)</span>
                    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Th. Stolarczyk.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>