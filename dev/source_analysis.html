

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Analyzing a single object &mdash; SoHAPPy 0.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="_static/plot_directive.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Dataset tools" href="tools.html" />
    <link rel="prev" title="sig_plot_cumulative" href="api/analysis.population.pop_plot.sig_plot_cumulative.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> SoHAPPy
          

          
          </a>

          
            
            
              <div class="version">
                dev
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="sohappy.html">How it works ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="irf.html">Instrument response functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="file_format.html">Input file format</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Concepts and classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="grb.html">Astrophysical objects (GRB)</a></li>
<li class="toctree-l1"><a class="reference internal" href="time_slice.html">Time slices and slots</a></li>
<li class="toctree-l1"><a class="reference internal" href="visibility.html">Visibilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="montecarlo.html">Monte Carlo</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analysis</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="population_analysis.html">Population analysis</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Analyzing a single object</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#dataset-plotting">Dataset plotting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#stacking-masking-and-associated-models">stacking, masking and associated models</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Dataset tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#utilities">Utilities</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The developer corner</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="developer.html">Todo list</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SoHAPPy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Analyzing a single object</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/source_analysis.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="analyzing-a-single-object">
<h1>Analyzing a single object<a class="headerlink" href="#analyzing-a-single-object" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
</div>
</div>
<div class="section" id="dataset-plotting">
<h1>Dataset plotting<a class="headerlink" href="#dataset-plotting" title="Permalink to this headline">¶</a></h1>
<p>Introduce the concept</p>
<div class="section" id="stacking-masking-and-associated-models">
<h2>stacking, masking and associated models<a class="headerlink" href="#stacking-masking-and-associated-models" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>A dataset ds can carry models, in particular a spectral model and a mask_safe.</p>
<blockquote>
<div><p>The mask_safe define the energy region on which the dataset data are considered valid.
It is in particular used during a fit and when several datasets are stacked together.</p>
<p>The model attached to a dataset can be used to simulate the count content. It can also be used for fitting. A model can be an analytical expression liek a powerlaw or a TemplateSpectraModel obtained from point measurement. In that case the model is an interpolation through the points.</p>
<p>Not that fitting the data with a model different from the one used for simulation is possible.
However the initial model should be saved before hand if it has to be reused:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_init</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">models</span>
<span class="n">model_fit</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spectral_model</span><span class="o">=</span><span class="n">PowerLawSpectralModel</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<span class="n">ds</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">model_fit</span>
<span class="n">Fit</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
<span class="n">ds</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">model_init</span> <span class="c1"># Go back to initial model</span>
</pre></div>
</div>
<p>The predcited counts in a dataset are computed using the model (and the IRF), which is a continous
function, at the center of the bins of the reconstrcuted axis (although the model is defined upon true energies).
When the mask is applied, the predicted counts in the masked bins are set to zero. But the model is
unchanged.</p>
<p>Stacking is usually intended to group several observations of a same phenomemon.
Each observation can have a different masking (e.g. varying energy thresholds), but all observations are intended
to be interpreted from the same fit model.</p>
<p>When simulatiing a source with a varying energy spectrum in time, this is the case with GRB simulations, each time
slice carries its own spectral model (in the most general case a template spectral model).</p>
<p>In Gammapy the model in a stacked model dsstack obtained from two datasets ds1 and ds2 is the ds1 model
(as it is supposed to be a fit model for a set of observations).</p>
<p>However it is possible to compute an equivalent mean model as the sum of the original models weighted by the
dataset livetime using a template spectral model.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">flux1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_model</span><span class="p">(</span><span class="n">e_axis</span><span class="o">.</span><span class="n">center</span><span class="p">)</span>
<span class="n">dt1</span>   <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">livetime</span>
<span class="n">flux2</span> <span class="o">=</span> <span class="n">ds2</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_model</span><span class="p">(</span><span class="n">e_axis</span><span class="o">.</span><span class="n">center</span><span class="p">)</span>
<span class="n">dt2</span>   <span class="o">=</span> <span class="n">ds2</span><span class="o">.</span><span class="n">livetime</span>

<span class="n">flux_new</span>  <span class="o">=</span> <span class="p">(</span><span class="n">dt1</span><span class="o">*</span><span class="n">flux1</span> <span class="o">+</span> <span class="n">dt2</span><span class="o">*</span><span class="n">flux2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dt1</span><span class="o">+</span><span class="n">dt2</span><span class="p">)</span>
<span class="n">spec</span>      <span class="o">=</span> <span class="n">TemplateSpectralModel</span><span class="p">(</span><span class="n">energy</span> <span class="o">=</span> <span class="n">e_axis</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
                         <span class="n">values</span> <span class="o">=</span> <span class="n">flux_org</span><span class="o">*</span><span class="n">mask_org</span><span class="p">,</span>
                         <span class="n">norm</span>   <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span>
                         <span class="n">interp_kwargs</span> <span class="o">=</span><span class="p">{</span><span class="s2">&quot;values_scale&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span><span class="p">})</span>
<span class="n">dsstack</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spectral_model</span> <span class="o">=</span> <span class="n">spec</span><span class="p">,</span> <span class="n">name</span>  <span class="o">=</span> <span class="s2">&quot;Stack&quot;</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">ds1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>This works perfectly as long as the two datasets are defined on the same energy range,
i.e. have the same mask_safe attribute.
With this, the predicted counts, that computed from the model, can still be compared to the generated counts
in a simulation</p>
<p>If the two datasets have NOT the same mask_safe attribute, one could set to zero the flux point in the definition
of the template spectral model as follows. Note that this requires to define the model on the reconstructed
energy axis (axis on whih the mask _safe is defined):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">e_axis</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># E reco sampling from the IRF</span>
<span class="n">mask1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">mask_safe</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">flux1</span> <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_model</span><span class="p">(</span><span class="n">e_axis</span><span class="o">.</span><span class="n">center</span><span class="p">)</span><span class="o">*</span><span class="n">mask1</span> <span class="c1"># masked bins at zero</span>
<span class="n">dt1</span>   <span class="o">=</span> <span class="n">ds1</span><span class="o">.</span><span class="n">livetime</span>
</pre></div>
</div>
<p>However the resulting interpolated spectrum can/will have edge effects that will not guarantee that the flux is
stricly at zero.</p>
<p>As a consequence it is not strictly possible to propagate a mean effective model when stackig two datasets.</p>
<p>The solution to check that the simulated count numbers follow the original modelling is to cumulate by hand the
prdicted counts from the original individual datasets.</p>
</div></blockquote>
</div></blockquote>
<p>#.. automodapi:: singlesource_analysis
#   :include-all-objects:
#   :no-inheritance-diagram:</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="tools.html" class="btn btn-neutral float-right" title="Dataset tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="api/analysis.population.pop_plot.sig_plot_cumulative.html" class="btn btn-neutral float-left" title="sig_plot_cumulative" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Th. Stolarczyk.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>