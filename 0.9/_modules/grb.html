<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>grb &mdash; SoHAPPy 0.9 beta documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> SoHAPPy
          </a>
              <div class="version">
                0.9
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">How to run it</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sohappy.html">How it works ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../irf.html">Instrument response functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../file_format.html">Input file format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../production.html">Running large simulations and analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Concepts and classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../grb.html">Astrophysical objects (GRB)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../time_slice.html">Time slices and slots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visibility.html">Visibilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simulation.html">Simulation and Analysis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analyzing the output files</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../population_analysis.html">Population analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spectral_analysis.html">Spectral analysis of an astrophysical source</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools.html">Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The developer corner</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">Building the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer.html#todo-list">Todo list</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SoHAPPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">grb</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for grb</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains the classes and tools to handle a GRB object, i.e.</span>
<span class="sd">a collection of lightcurve bins for each of which is given an energy spectrum,</span>
<span class="sd">an explosion (trigger) time and physical characteristics.</span>

<span class="sd">Created on Tue Jan 22 11:41:34 2019</span>

<span class="sd">@author: Stolar</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>

<span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">import</span> <span class="nn">astropy.units</span>         <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span>   <span class="nn">astropy.table</span>         <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">QTable</span>
<span class="kn">from</span>   <span class="nn">astropy.io</span>            <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span>   <span class="nn">astropy.time</span>          <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span>   <span class="nn">astropy.coordinates</span>   <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span>   <span class="nn">astropy.coordinates</span>   <span class="kn">import</span> <span class="n">AltAz</span>
<span class="kn">from</span>   <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">quantity_support</span>

<span class="kn">import</span> <span class="nn">observatory</span> <span class="k">as</span> <span class="nn">obs</span>
<span class="kn">from</span> <span class="nn">visibility</span> <span class="kn">import</span> <span class="n">Visibility</span>

<span class="kn">from</span> <span class="nn">niceprint</span> <span class="kn">import</span> <span class="n">warning</span><span class="p">,</span> <span class="n">failure</span>
<span class="kn">from</span> <span class="nn">niceplot</span> <span class="kn">import</span> <span class="n">single_legend</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="n">get_filename</span>

<span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">Models</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">PointSpatialModel</span><span class="p">,</span> <span class="n">SkyModel</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">EBLAbsorptionNormSpectralModel</span>
<span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">TemplateSpectralModel</span>

<span class="c1"># Transform warnings into errors - useful to find who is guilty !</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="c1">#warnings.filterwarnings(&#39;error&#39;)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GammaRayBurst&quot;</span><span class="p">]</span>

<span class="c1">###############################################################################</span>
<div class="viewcode-block" id="GammaRayBurst"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst">[docs]</a><span class="k">class</span> <span class="nc">GammaRayBurst</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to store GRB properties.</span>

<span class="sd">    The GRB information is read from files.</span>
<span class="sd">    A GRB is composed of several parameters among which, a name, a redshift,</span>
<span class="sd">    a position in the sky, and measurement points in time at which</span>
<span class="sd">    an energy spectrum is given.</span>

<span class="sd">    Each energy spectrum is given as a series of flux measurements but is then</span>
<span class="sd">    stored as an interpolated spectrum* (i.e. the energy bin width has a modest</span>
<span class="sd">    importance).</span>

<span class="sd">    The GRB properties like `z` and `Eiso` connect the afterglow and prompt</span>
<span class="sd">    emissions together.</span>

<span class="sd">    The original energy bins can be limited by a maximal maximal energy</span>
<span class="sd">    (Limitation in time can be obtained from the visibility computation).</span>

<span class="sd">    The spectra are usually modified for an EBL absorption, or the absorbed</span>
<span class="sd">    flux is given in the file in some cases.</span>

<span class="sd">    The afterglow flux can be adjusted by a multiplicative factor for</span>
<span class="sd">    various tests.</span>

<span class="sd">    If requested, the associated prompt spectrum is read and added to the</span>
<span class="sd">    afterglow spectra to give the total contribution.</span>

<span class="sd">    **Note:**</span>

<span class="sd">    Following a question on the `Slack gammapy` channel on November 27 :sup:`th` ,</span>
<span class="sd">    and the answer by Axel Donath:</span>

<span class="sd">    The following statement later in the code gave an error</span>
<span class="sd">    (:code:`dlist_onoff` is a collection of `Dataset`)</span>
<span class="sd">    :code:`dlist_onoff.write(datapath,prefix=&quot;cls&quot;,overwrite=True)`</span>
<span class="sd">    gives:</span>

<span class="sd">     ..  code-block:: python</span>

<span class="sd">        ..\\gammapy\\modeling\\models\\spectral.py&quot;,</span>
<span class="sd">        line 989, in to_dict &quot;data&quot;: self.energy.data.tolist(),</span>
<span class="sd">        NotImplementedError: memoryview: unsupported format &gt;f</span>


<span class="sd">    This error comes from the fact that the energy list as to be</span>
<span class="sd">    explicitely passed as a float as done below: :code:`cls.Eval.astype(float)`</span>
<span class="sd">    (A `Quantity` is passed as requested but the underlying numpy</span>
<span class="sd">    dtype is not supported by :code:`energy.data.tolist()`)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ignore</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;Eval&quot;</span><span class="p">,</span><span class="s2">&quot;tval&quot;</span><span class="p">,</span> <span class="s2">&quot;tstart&quot;</span><span class="p">,</span> <span class="s2">&quot;tstop&quot;</span><span class="p">,</span> <span class="s2">&quot;fluxval&quot;</span><span class="p">,</span>
              <span class="s2">&quot;spec_afterglow&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;id90&quot;</span><span class="p">,</span> <span class="s2">&quot;E_prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;flux_prompt&quot;</span><span class="p">,</span>
              <span class="s2">&quot;spec_prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="s2">&quot;vis&quot;</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot; Ignore these members when dumping the class out.&quot;&quot;&quot;</span>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.__init__"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This initializes a default GRB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span>       <span class="o">=</span> <span class="s1">&#39;dummy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># File with the spectral and lightcurve data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span>        <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Redshift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eblmodel</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># GRB properties - Dummy default values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radec</span>     <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span> <span class="o">-</span><span class="mi">15</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Eiso</span>      <span class="o">=</span> <span class="mf">0.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">erg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Liso</span>      <span class="o">=</span> <span class="mf">0.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;erg/s&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Epeak</span>     <span class="o">=</span> <span class="mf">0.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">keV</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t90</span>       <span class="o">=</span> <span class="mf">0.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G0H</span>       <span class="o">=</span> <span class="mf">0.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G0W</span>       <span class="o">=</span> <span class="mf">0.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fpeak</span>     <span class="o">=</span> <span class="mf">0.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">erg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fpeak_GBM</span> <span class="o">=</span> <span class="mf">0.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">erg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamle</span>     <span class="o">=</span> <span class="mf">0.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamhe</span>     <span class="o">=</span> <span class="mf">0.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>

        <span class="c1"># GRB explosion time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_trig</span>   <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="s1">&#39;2020-01-01T02:00:00&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;isot&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>

        <span class="c1">#------------</span>
        <span class="c1">### Afterglow</span>
        <span class="c1">#------------</span>

        <span class="c1"># Afterglow Flux table - Spectra at a series of points in time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Eval</span>           <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span> <span class="c1"># Energy values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tval</span>           <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>   <span class="c1"># Time values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstart</span>         <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>     <span class="c1"># Start time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span>          <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>     <span class="c1"># Stop time</span>

        <span class="c1"># Raw flux arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fluxval</span>        <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;1 / (cm2 GeV s)&quot;</span><span class="p">)</span>

        <span class="c1"># Afterglow interpolated arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_afterglow</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#-------------------</span>
        <span class="c1">### Prompt component</span>
        <span class="c1">#-------------------</span>
        <span class="c1"># Default : no prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>      <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Afterglow Slice id at which the prompt stops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id90</span>        <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Prompt energy bins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E_prompt</span>    <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span>

        <span class="c1"># Prompt raw flux value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux_prompt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;1 / (cm2 GeV s)&quot;</span><span class="p">)</span>

        <span class="c1"># One Interpolated, non attenuated E-spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_prompt</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#-------------</span>
        <span class="c1">### Total flux</span>
        <span class="c1">#-------------</span>
        <span class="c1"># If the prompt flux exist, this the sum of both flux until the</span>
        <span class="c1"># last time bin of the afterglow flux below t90 of the prompt.</span>

        <span class="c1"># Gammapy Skymodel models (one per t slice)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#-------------</span>
        <span class="c1">### Visibility</span>
        <span class="c1">#-------------</span>
        <span class="c1"># Visibility - dictionnary with site entries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vis</span>  <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.from_fits"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.from_fits">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_fits</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                  <span class="n">filename</span><span class="p">,</span>
                  <span class="n">prompt</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">ebl</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">Emax</span>    <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">dt</span>      <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">magnify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="n">vis_from_file</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the GRB data from a `fits` file.</span>
<span class="sd">        Fluxes are given for a series of (t,E) values</span>
<span class="sd">        So far no flux exists beyond the last point (no extrapolation).</span>

<span class="sd">        The spectrum is stored as a table, :obj:`TemplateSpectralModel`, that takes</span>
<span class="sd">        as an input a series of flux values as a function of the energy.</span>
<span class="sd">        The model will return values interpolated in log-space with</span>
<span class="sd">        :func:`scipy.interpolate.interp1d`, returning zero for energies</span>
<span class="sd">        outside of the limits of the provided energy array.</span>

<span class="sd">        In this function, the trigger time (time of the GRB explosion), is</span>
<span class="sd">        expected to come from the input file, with the possibility to add a</span>
<span class="sd">        constant time shift in days, or is set randomly over the default year.</span>
<span class="sd">        Alternatively, the dates can be overwritten by dates stored in</span>
<span class="sd">        an external file in the `SoHAPPy.py` main process using</span>
<span class="sd">        :func:`grb.GammaRayBurst.set_visibility` function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cls : GammaRayBurst class</span>
<span class="sd">            GammaRayBurst class instance.</span>
<span class="sd">        filename : Path</span>
<span class="sd">            GRB input file name.</span>
<span class="sd">        prompt: Boolean</span>
<span class="sd">            If True, read information from the associated prompt component.</span>
<span class="sd">        ebl : String, optional</span>
<span class="sd">            The EBL absorption model considered. If ebl is `built-in`, uses</span>
<span class="sd">            the absorbed specrum from the data if available. Can be `None`.</span>
<span class="sd">        Emax : Astropy Quantity, optionnal</span>
<span class="sd">           Maximal energy considered in the data. The default is `None`.</span>
<span class="sd">        dt: float, optionnal</span>
<span class="sd">            A number of Julian days to be added to the present source trigger</span>
<span class="sd">            time. The default is 0.0.</span>
<span class="sd">        magnify : float, optional</span>
<span class="sd">            Flux multiplicative factor to the afterglow model flux for tests.</span>
<span class="sd">            Default is 1.</span>
<span class="sd">        vis_from_file: Boolean, optional</span>
<span class="sd">            If True the visibility is read from the file.</span>
<span class="sd">            The default is `False`.</span>
<span class="sd">        debug: Boolean, optional</span>
<span class="sd">            Debugging flag. The default is False.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A GammaRayBurst instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">### -----------------------------------------------------</span>
        <span class="c1">### Open file, get header, keys, and data fill the class members</span>
        <span class="c1">### -----------------------------------------------------</span>
        <span class="n">hdul</span>   <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">get_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">hdr</span>    <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">keys_0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="n">GammaRayBurst</span><span class="p">()</span> <span class="c1"># Default constructor</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">z</span>        <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">eblmodel</span> <span class="o">=</span> <span class="n">ebl</span>

        <span class="c1"># Get identifier by removing all extensions</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">suffixes</span><span class="p">))</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">radec</span>    <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">Eiso</span>     <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;EISO&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">erg</span>

        <span class="k">if</span> <span class="s2">&quot;LISO&quot;</span> <span class="ow">in</span> <span class="n">keys_0</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Liso</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s2">&quot;LISO&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;erg/s&quot;</span><span class="p">)</span> <span class="c1"># New large prod. files</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Liso</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;erg/s&quot;</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">Epeak</span>    <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;EPEAK&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">keV</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">t90</span>      <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;Duration&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">G0H</span>      <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;G0H&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;G0W&quot;</span> <span class="ow">in</span> <span class="n">keys_0</span><span class="p">:</span> <span class="c1"># Not in SHORTFITS</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">G0W</span>      <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;G0W&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;PHFLUX&quot;</span> <span class="ow">in</span> <span class="n">keys_0</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Fpeak</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PHFLUX&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;cm-2.s-1&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;PHFX&quot;</span> <span class="ow">in</span> <span class="n">keys_0</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Fpeak</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PHFX&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;cm-2.s-1&quot;</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">gamle</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;LOWSP&#39;</span><span class="p">]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">gamhe</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;HIGHSP&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;PHFX_GBM&quot;</span> <span class="ow">in</span> <span class="n">keys_0</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Fpeak_GBM</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;PHFX_GBM&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;cm-2.s-1&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Fpeak_GBM</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;cm-2.s-1&quot;</span><span class="p">)</span>

        <span class="c1">###--------------------------</span>
        <span class="c1">### GRB trigger time</span>
        <span class="c1">###--------------------------</span>
        <span class="c1"># If the input file does not contain a trigger date, then set a date</span>
        <span class="c1"># by default. It is very likely that this source belongs to a set</span>
        <span class="c1"># for which a list of explosion (trigger) times should be generated.</span>

        <span class="k">if</span> <span class="s2">&quot;GRBJD&quot;</span> <span class="ow">in</span> <span class="n">keys_0</span><span class="p">:</span> <span class="c1"># Not in SHORTFITS</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">t_trig</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;GRBJD&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">day</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                              <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;jd&quot;</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="s2">&quot;utc&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;GRBTIME&quot;</span> <span class="ow">in</span> <span class="n">keys_0</span><span class="p">:</span> <span class="c1"># Add start date</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">t_trig</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;GRBTIME&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                              <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;jd&quot;</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="s2">&quot;utc&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">:}</span><span class="s2">.py: Trigger time absent from file, using random value&quot;</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">random</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">t_trig</span> <span class="o">+=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">365</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">day</span>

        <span class="c1">###--------------------------</span>
        <span class="c1">### Time intervals - so far common to afterglow and prompt</span>
        <span class="c1">###--------------------------</span>
        <span class="n">tval</span>  <span class="o">=</span> <span class="n">QTable</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;TIMES (AFTERGLOW)&quot;</span><span class="p">])</span>

        <span class="c1"># Temporary : in short GRB fits file, unit is omitted</span>
        <span class="c1"># The flux value is given on an interval (&quot;col0&quot;, &quot;col1°°.</span>
        <span class="c1"># The default is to consider that the flux is valid at the end of the</span>
        <span class="c1"># interval.</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tval</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">astropy</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">quantity</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tval</span><span class="p">[</span><span class="n">tval</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="n">tval</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># In SHORT GRB, the time bin is given, [t1, t2].</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tval</span><span class="p">[</span><span class="s2">&quot;col1&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">tstart</span>   <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">t_trig</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">tstop</span>    <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">t_trig</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">###--------------------------</span>
        <span class="c1">### Afterglow Energies - Limited to Emax if defined</span>
        <span class="c1">###--------------------------</span>
        <span class="n">tab_key</span> <span class="o">=</span> <span class="s2">&quot;Energies (afterglow)&quot;</span>
        <span class="n">col_key</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="n">tab_key</span><span class="p">])</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span>  <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="n">tab_key</span><span class="p">])[</span><span class="n">col_key</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span><span class="p">)</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>

        <span class="k">if</span> <span class="n">Emax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Emax</span><span class="o">&lt;=</span><span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">warning</span><span class="p">(</span><span class="s2">&quot; Data up to </span><span class="si">{:5.3f}</span><span class="s2"> restricted to </span><span class="si">{:5.3f}</span><span class="s2">&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">Emax</span><span class="p">))</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span><span class="o">&lt;=</span> <span class="n">Emax</span><span class="p">]</span>

        <span class="c1">###--------------------------</span>
        <span class="c1">### Afterglow flux</span>
        <span class="c1">###--------------------------</span>

        <span class="c1"># Get flux, possibly already absorbed</span>
        <span class="k">if</span> <span class="n">ebl</span> <span class="o">==</span> <span class="s2">&quot;in-file&quot;</span><span class="p">:</span> <span class="c1"># Read default absorbed model</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">QTable</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;EBL-ABS. SPECTRA (AFTERGLOW)&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">QTable</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;SPECTRA (AFTERGLOW)&quot;</span><span class="p">])</span>

        <span class="n">flux_unit</span>    <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;UNITS&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">flux_unit</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ph&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">flux_unit</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;ph&quot;</span><span class="p">)</span> <span class="c1"># Removes ph</span>

        <span class="c1"># Store the flux. Note the transposition</span>
        <span class="n">itmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">tval</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">jEmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">fluxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">itmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jEmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">flux_unit</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">itmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">jEmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">magnify</span><span class="o">*</span> <span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">flux_unit</span> <span class="c1"># transp!</span>

        <span class="c1"># Build time series of interpolated spectra - limited to dtmax</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">tval</span><span class="p">)):</span>
            <span class="n">glow</span> <span class="o">=</span> <span class="n">TemplateSpectralModel</span><span class="p">(</span><span class="n">energy</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
                                         <span class="n">values</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                         <span class="n">interp_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;values_scale&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span><span class="p">})</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">spec_afterglow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">glow</span><span class="p">)</span>

        <span class="c1">###--------------------------</span>
        <span class="c1">### Prompt - a unique energy spectrum</span>
        <span class="c1">###--------------------------</span>

        <span class="c1"># Get the prompt if potentially visible and if requested</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># No prompt component was found</span>
        <span class="k">if</span> <span class="n">prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="c1"># if cls.vis[&quot;North&quot;].vis_prompt or cls.vis[&quot;South&quot;].vis_prompt:</span>
                <span class="c1"># Deduce prompt folder from GRB path name</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">spec_prompt</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_prompt</span><span class="p">(</span><span class="n">folder</span> <span class="o">=</span> <span class="n">prompt</span><span class="p">,</span>
                                                 <span class="n">debug</span>  <span class="o">=</span> <span class="n">debug</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">spec_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{}</span><span class="s2"> is not a valid data folder :&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prompt</span><span class="p">))</span>

        <span class="c1">###--------------------------</span>
        <span class="c1">### Total attenuated spectra</span>
        <span class="c1">###--------------------------</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">tval</span><span class="p">):</span>
            <span class="n">spec_tot</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">spec_afterglow</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">prompt</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">&lt;=</span><span class="bp">cls</span><span class="o">.</span><span class="n">id90</span><span class="p">:</span> <span class="n">spec_tot</span> <span class="o">+=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">spec_prompt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spectral_model</span><span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">EBLabsorbed</span><span class="p">(</span><span class="n">spec_tot</span><span class="p">,</span><span class="n">ebl</span><span class="p">),</span>
                         <span class="n">spatial_model</span> <span class="o">=</span> <span class="n">PointSpatialModel</span><span class="p">(</span><span class="n">lon_0</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">radec</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
                                                           <span class="n">lat_0</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">radec</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>
                                                           <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">),</span>
                             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;model_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="c1">### Close fits file</span>
        <span class="n">hdul</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">cls</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.historical_from_yaml"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.historical_from_yaml">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">historical_from_yaml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">ebl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">magnify</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the characteristics of a parameterised GRB from a `yaml` file.</span>
<span class="sd">        It is assumed that the energy and time decays are not correlated and</span>
<span class="sd">        follow two independent power laws.</span>
<span class="sd">        The function associates spectra to a list of time intervals</span>
<span class="sd">        in order to comply with the more general case in this class.</span>
<span class="sd">        Note that the spectra are considered to be from the afterglow only.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A `GammaRayBurst` instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="n">GammaRayBurst</span><span class="p">()</span> <span class="c1"># This calls the constructor</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">filename</span>  <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                         <span class="s2">&quot;data/historical/GRB_&quot;</span><span class="o">+</span><span class="n">item</span><span class="o">+</span><span class="s2">&quot;.yml&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">yaml</span>
            <span class="kn">from</span> <span class="nn">yaml.loader</span> <span class="kn">import</span> <span class="n">SafeLoader</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">SafeLoader</span><span class="p">)</span>


        <span class="bp">cls</span><span class="o">.</span><span class="n">z</span>        <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">eblmodel</span> <span class="o">=</span> <span class="n">ebl</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">id</span>       <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">radec</span>  <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">Eiso</span>   <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Eiso&quot;</span><span class="p">])</span>
        <span class="c1"># self.Liso  = 0.*u.Unit(&quot;erg/s&quot;)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">Epeak</span>  <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Epeak&#39;</span><span class="p">])</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">t90</span>    <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;t90&#39;</span><span class="p">])</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">G0H</span>    <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;G0H&#39;</span><span class="p">]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">G0W</span>    <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;G0W&#39;</span><span class="p">]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">Fpeak</span>  <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Fluxpeak&#39;</span><span class="p">])</span>
        <span class="c1"># self.Fpeak_GBM = 0.*u.erg</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">gamle</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;gamma_le&#39;</span><span class="p">]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">gamhe</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;gamma_he&#39;</span><span class="p">]</span>

        <span class="c1">###--------------------------</span>
        <span class="c1">### GRB trigger time</span>
        <span class="c1">###--------------------------</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">t_trig</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;t_trig&quot;</span><span class="p">],</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="s2">&quot;utc&quot;</span><span class="p">)</span>

        <span class="c1">###--------------------------</span>
        <span class="c1">### Time intervals</span>
        <span class="c1">###--------------------------</span>
        <span class="n">tmin</span>     <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tmin&quot;</span><span class="p">]),</span><span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="c1"># Cannot be zero</span>
        <span class="n">tmax</span>     <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tmax&quot;</span><span class="p">])</span>
        <span class="n">ntbin</span>    <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ntbin&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ntbin</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">tmin</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">tmax</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                                   <span class="n">ntbin</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># A single time window</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">tval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tmin</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">tmax</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">tmin</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">])</span><span class="o">*</span><span class="n">tmin</span><span class="o">.</span><span class="n">unit</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">tstart</span>   <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">t_trig</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">tstop</span>    <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">t_trig</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">###--------------------------</span>
        <span class="c1">### Afterglow Energies - Limited to Emin, Emax</span>
        <span class="c1">###--------------------------</span>
        <span class="n">Emin</span>     <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Emin&quot;</span><span class="p">])</span>
        <span class="n">Emax</span>     <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Emax&quot;</span><span class="p">])</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">Emin</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                               <span class="n">Emax</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">Emin</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">])</span><span class="o">*</span><span class="n">Emin</span><span class="o">.</span><span class="n">unit</span>

        <span class="c1">###--------------------------</span>
        <span class="c1">### Afterglow flux</span>
        <span class="c1">###--------------------------</span>

        <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;1/(cm2 GeV s)&quot;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">fluxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">tval</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span><span class="p">))</span> <span class="p">)</span><span class="o">*</span><span class="n">flux_unit</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">tval</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">E</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span><span class="p">):</span>
                <span class="n">dnde</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;K&quot;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;E0&quot;</span><span class="p">])</span><span class="o">**-</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;gamma&quot;</span><span class="p">]</span>
                                 <span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;t0&quot;</span><span class="p">])</span><span class="o">**-</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">])</span>
                <span class="c1">#print(i,j,dnde)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">magnify</span><span class="o">*</span> <span class="n">dnde</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">flux_unit</span><span class="p">)</span>

        <span class="c1">###--------------------------</span>
        <span class="c1">### Prompt - No prompt foreseen in this case</span>
        <span class="c1">###--------------------------</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1">###--------------------------</span>
        <span class="c1">### Total attenuated spectra</span>
        <span class="c1">###--------------------------</span>
        <span class="c1"># See note in from_fits for explanatins on some parameters</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">tval</span><span class="p">):</span>

            <span class="n">tab</span> <span class="o">=</span> <span class="n">TemplateSpectralModel</span><span class="p">(</span><span class="n">energy</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
                                        <span class="n">values</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">interp_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;values_scale&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span><span class="p">})</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">spec_afterglow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span> <span class="c1"># Needed for display</span>


            <span class="n">m</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spectral_model</span><span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">EBLabsorbed</span><span class="p">(</span><span class="n">tab</span><span class="p">),</span>
                         <span class="n">spatial_model</span> <span class="o">=</span> <span class="n">PointSpatialModel</span><span class="p">(</span><span class="n">lon_0</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">radec</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
                                                           <span class="n">lat_0</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">radec</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>
                                                           <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s2">&quot;model_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.prompt"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.prompt">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">prompt</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">glowname</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ebl</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="p">,</span> <span class="n">magnify</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is for tests using time-resolved spectra.</span>
<span class="sd">        It reads prompt data from a file and associate the prompt to the</span>
<span class="sd">        afterglow if requested (or keep the default from the constructor</span>
<span class="sd">        otherwise, with possibility to supersede the redshift and the flux</span>
<span class="sd">        multiplicative factor). It does not add the two spectra as this would</span>
<span class="sd">        require to work on the energy and time binnings that are different and</span>
<span class="sd">        this is not implemented yet.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : Path</span>
<span class="sd">            Prompt file path.</span>
<span class="sd">        glowname : Path, optional</span>
<span class="sd">            Afterglow file path. The default is None.</span>
<span class="sd">        ebl : string, optional</span>
<span class="sd">            Name of the EBL model. The default is None.</span>
<span class="sd">        z : Quantity, optional</span>
<span class="sd">            redshift. The default is 0*u.dimensionless_unscaled.</span>
<span class="sd">        magnify : float, optional</span>
<span class="sd">            Multiplicative factor of the flux. The default is 1.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        GammaRayBurst</span>
<span class="sd">            New instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">:}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="c1"># Read prompt data -supersede defaults</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">GammaRayBurst</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span> <span class="n">z</span>       <span class="o">=</span> <span class="n">z</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">magnifiy</span> <span class="o">=</span> <span class="n">magnify</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">eblmodel</span> <span class="o">=</span> <span class="n">ebl</span>

        <span class="c1"># Copy missing data from the corresponding afterglow</span>
        <span class="k">if</span> <span class="n">glowname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">glow</span> <span class="o">=</span> <span class="n">GammaRayBurst</span><span class="o">.</span><span class="n">from_fits</span><span class="p">(</span><span class="n">glowname</span><span class="p">)</span>
            <span class="c1"># print(glow)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">z</span>         <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">z</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">radec</span>     <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">radec</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Eiso</span>      <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">Eiso</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Liso</span>      <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">Liso</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Epeak</span>     <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">Epeak</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Fpeak</span>     <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">Fpeak</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">t90</span>       <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">t90</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">G0H</span>       <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">G0H</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">G0W</span>       <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">G0W</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">gamle</span>     <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">gamle</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">gamhe</span>     <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">gamhe</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">Fpeak_GBM</span> <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">Fpeak_GBM</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">t_trig</span>    <span class="o">=</span> <span class="n">glow</span><span class="o">.</span><span class="n">t_trig</span>

        <span class="c1"># Reads prompt data</span>
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span>     <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hdul</span><span class="p">,</span><span class="n">hdu</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">TeV</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">tval</span>     <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hdul</span><span class="p">,</span><span class="n">hdu</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">quantity</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">tstart</span>   <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">t_trig</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">tstop</span>    <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">t_trig</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">flux</span>         <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">hdul</span><span class="p">,</span><span class="n">hdu</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;1/(cm2 TeV s)&quot;</span><span class="p">)</span>
        <span class="n">icol_t</span>       <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>          <span class="c1"># column number - time</span>
        <span class="n">jrow_E</span>       <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">flux</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="c1"># row number</span>

        <span class="c1"># Note the transposition from flux to fluxval</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">fluxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">icol_t</span><span class="p">,</span><span class="n">jrow_E</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">flux_unit</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">icol_t</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">jrow_E</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># print(i,j,f)</span>
                    <span class="n">f</span> <span class="o">=</span><span class="mi">0</span> <span class="c1"># Correct a bug in event #172 - to be removed</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">magnify</span><span class="o">*</span><span class="n">f</span><span class="o">*</span><span class="n">flux_unit</span> <span class="c1"># transp!</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">tval</span><span class="p">)):</span>
            <span class="c1"># Note that TableModel makes an interpolation</span>
            <span class="n">prpt</span> <span class="o">=</span> <span class="n">TemplateSpectralModel</span><span class="p">(</span><span class="n">energy</span>  <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Eval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
                                         <span class="n">values</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                         <span class="n">interp_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;values_scale&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span><span class="p">})</span>
            <span class="c1"># Use the afterglow place holder to store the prompt</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">spec_afterglow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prpt</span><span class="p">)</span>

            <span class="n">m</span> <span class="o">=</span> <span class="n">SkyModel</span><span class="p">(</span><span class="n">spectral_model</span><span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">EBLabsorbed</span><span class="p">(</span><span class="n">prpt</span><span class="p">,</span><span class="n">ebl</span><span class="p">),</span>
                         <span class="n">spatial_model</span> <span class="o">=</span> <span class="n">PointSpatialModel</span><span class="p">(</span><span class="n">lon_0</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">radec</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span>
                                                           <span class="n">lat_0</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">radec</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>
                                                           <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;icrs&quot;</span><span class="p">),</span>
                                                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;model_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="c1"># Not adding the avraged on time prompt</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">hdul</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">cls</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.EBLabsorbed"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.EBLabsorbed">[docs]</a>    <span class="k">def</span> <span class="nf">EBLabsorbed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tab</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the EBL-absorbed model of the current instance.</span>
<span class="sd">        Absorption data are either obtained from the Gammapy datasets or from</span>
<span class="sd">        external proprietary files. Data are unchanged if the GRB has</span>
<span class="sd">        already attenuated spectra or if no absorption is considered.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tab : Gammapy TemplateSpectralModel</span>
<span class="sd">            A flux versus energy as an interpolated table.</span>
<span class="sd">        model : String</span>
<span class="sd">            An EBL model name among those available.</span>
<span class="sd">        debug : Boolean, optional</span>
<span class="sd">            If True let&#39;s talk a bit. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        attflux : TemplateSpectralModel</span>
<span class="sd">            An attenuated flux versus energy as an interpolated table.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">attflux</span> <span class="o">=</span> <span class="n">tab</span> <span class="c1"># Initialise to the unabsorbed flux</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eblmodel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">eblmodel</span> <span class="o">==</span> <span class="s1">&#39;in-file&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">attflux</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eblmodel</span> <span class="o">!=</span> <span class="s2">&quot;gilmore&quot;</span><span class="p">:</span>
            <span class="n">eblabs</span> <span class="o">=</span> <span class="n">EBLAbsorptionNormSpectralModel</span><span class="o">.</span><span class="n">read_builtin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eblmodel</span><span class="p">,</span>
                                                              <span class="n">redshift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
            <span class="n">attflux</span> <span class="o">=</span> <span class="n">tab</span><span class="o">*</span><span class="n">eblabs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">ebl</span> <span class="kn">import</span> <span class="n">EBL_from_file</span>
            <span class="n">eblabs</span> <span class="o">=</span> <span class="n">EBL_from_file</span><span class="p">(</span><span class="s2">&quot;data/ebl/others/ebl_gilmore12-10GeV.dat&quot;</span><span class="p">)</span>
            <span class="c1"># Change flux for absorption, recreate model</span>
            <span class="c1"># I di not fine a clever way</span>
            <span class="n">attenuated</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">E</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">:</span>
                <span class="n">attenuated</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">eblabs</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
            <span class="n">attenuated</span> <span class="o">*=</span> <span class="n">tab</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">))</span><span class="o">.</span><span class="n">unit</span>
            <span class="n">attflux</span> <span class="o">=</span> <span class="n">TemplateSpectralModel</span><span class="p">(</span><span class="n">energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
                                            <span class="n">values</span> <span class="o">=</span> <span class="n">attenuated</span><span class="p">,</span>
                                            <span class="n">interp_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;values_scale&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">attflux</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.set_visibility"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.set_visibility">[docs]</a>    <span class="k">def</span> <span class="nf">set_visibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_night</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_skip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">status</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">dbg</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attach a visibility to a GRB instance.</span>
<span class="sd">        Either recompute it if a keyword has been given and a dictionnary</span>
<span class="sd">        retrieved or read it from the specified folder or dictionnary.</span>

<span class="sd">        * If a dictionnary is given, it can be:</span>

<span class="sd">            1. From the :obj:`visibility.yaml` file - the visibility is</span>
<span class="sd">               computed on the fly.</span>
<span class="sd">            2. Not from the :obj:`visibility.yaml` file, the dictionnary</span>
<span class="sd">               contains a computed visibility from a `json` file.</span>

<span class="sd">        * The keyword is among those:</span>

<span class="sd">            * **built-in**, the visibility is read from the fits file.</span>
<span class="sd">            * **forced**, the visibility is build assuming one infinite</span>
<span class="sd">              night.</span>
<span class="sd">            * **permanent**, the visibility is permanent, i.e. the night is</span>
<span class="sd">              infinite and the GRB is above the horizon. In that case it</span>
<span class="sd">              can be useful to force the zenith angle to be fixed at a</span>
<span class="sd">              certain value.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">### Update the default instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span> <span class="o">=</span> <span class="n">Visibility</span><span class="p">(</span><span class="n">pos</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radec</span><span class="p">,</span>
                                   <span class="n">site</span>   <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="s2">&quot;CTA&quot;</span><span class="p">][</span><span class="n">loc</span><span class="p">],</span>
                                   <span class="n">window</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tstart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span><span class="p">],</span>
                                   <span class="n">name</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">loc</span><span class="p">,</span>
                                   <span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">)</span>

        <span class="c1"># At this stage the visibility is maximal</span>
        <span class="k">if</span> <span class="n">info</span> <span class="o">==</span> <span class="s2">&quot;permanent&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;permanent&quot;</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span> <span class="c1"># A dictionnary not a keyword</span>

            <span class="k">if</span> <span class="s2">&quot;altmin&quot;</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1"># Compute from dictionnary</span>

                <span class="c1"># Supersede max. number of nights and nights to be skipped</span>
                <span class="k">if</span> <span class="n">n_night</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_night</span>
                <span class="k">if</span> <span class="n">n_skip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;skip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_skip</span>

                <span class="c1"># Compute from dictionnary elements</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">param</span> <span class="o">=</span> <span class="n">info</span><span class="p">,</span><span class="n">debug</span> <span class="o">=</span> <span class="n">dbg</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span> <span class="c1"># A dictionnary of all visibilities (from a .json file)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span>  <span class="o">=</span> <span class="n">Visibility</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">loc</span><span class="p">])</span>

        <span class="c1"># Not a dictionnary</span>
        <span class="k">elif</span> <span class="n">info</span> <span class="o">==</span> <span class="s2">&quot;built-in&quot;</span><span class="p">:</span>
            <span class="c1"># sys.exit(&quot;{}.py : built-in vis. reading to be reimplemented&quot;</span>
            <span class="c1">#          .format(__name__))</span>
            <span class="c1"># infolder is not passed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span>  <span class="o">=</span> <span class="n">Visibility</span><span class="o">.</span><span class="n">from_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># Special or from disk</span>

            <span class="k">if</span> <span class="n">info</span> <span class="o">==</span> <span class="s2">&quot;forced&quot;</span><span class="p">:</span> <span class="c1"># Infinitite nights</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">force_night</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span> <span class="c1"># Binary - Obsolete - Archived bin files might be not valid</span>
                <span class="kn">import</span> <span class="nn">pickle</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">loc</span><span class="o">+</span><span class="s2">&quot;_vis.bin&quot;</span><span class="p">),</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span> <span class="o">=</span>  <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

<span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.altaz"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.altaz">[docs]</a>    <span class="k">def</span> <span class="nf">altaz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get altitude azimuth for the GRB at a given site at GRB time t (s)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        location : string</span>
<span class="sd">            Either `North` or `South`.</span>
<span class="sd">        dt : Quantity (time)</span>
<span class="sd">            The time elapsed since the trigger time</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        altaz : astropy.coordinates.AltAz</span>
<span class="sd">            The GRB poistion in the sky at the given time and site.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">astropy</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">quantity</span><span class="o">.</span><span class="n">Quantity</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Time has to be a quantity (weird behaviour otherwise&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">altaz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radec</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">AltAz</span><span class="p">(</span><span class="n">obstime</span>  <span class="o">=</span> <span class="n">dt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_trig</span><span class="p">,</span>
                                                  <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">site</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">altaz</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.get_prompt"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.get_prompt">[docs]</a>    <span class="k">def</span> <span class="nf">get_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the time averaged prompt component associated to the afterglow.</span>
<span class="sd">        The prompt spectra are produced so that they correspond to the values</span>
<span class="sd">        of the physical parameters from the population (Lorentz Factor,</span>
<span class="sd">        peak energy, photon flux, and redshift).</span>
<span class="sd">        A single set of spectra is given spanning over the `T90` GRB duration.</span>
<span class="sd">        The flux is an &quot;average&quot; prompt spectrum over `T90`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folder : String, optional</span>
<span class="sd">            Where to find the prompt data below the &#39;lightcurves/prompt&#39;</span>
<span class="sd">            folder. The default is None.</span>
<span class="sd">        strict : Boolean, optional</span>
<span class="sd">            If True, requires that the density profile agrees between the</span>
<span class="sd">            prompt and the afterglow.</span>
<span class="sd">        debug : Boolean, optional</span>
<span class="sd">            If True, let&#39;s talk a bit. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List of Models</span>
<span class="sd">            List of `Gammapy` models for the Prompt component.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Find back the source id number from the id (assumes only the id has digits)</span>
        <span class="n">gid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">gid</span> <span class="o">+=</span> <span class="n">s</span>

        <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gid</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">30</span> <span class="p">,</span><span class="mi">191</span><span class="p">]:</span>
                <span class="n">failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; GRB prompt </span><span class="si">{</span><span class="n">gid</span><span class="si">:}</span><span class="s2"> simulated with a Wind profile&quot;</span><span class="p">)</span>
                <span class="n">failure</span><span class="p">(</span><span class="s2">&quot; It cannot be associated to the current afterglow !&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1">###----------------------------</span>
        <span class="c1">### Compute weihts to &quot;Mask&quot; the time interval beyond t90</span>
        <span class="c1">###----------------------------</span>

        <span class="c1"># Find the closest time bin at t90 in the Afterglow</span>
        <span class="c1"># id90 is the index of the time following the t90 value</span>
        <span class="c1"># t90 is therefore between the index id90-1 and id90</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id90</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t90</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id90</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">:}</span><span class="s2"> : t90 = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">t90</span><span class="si">:}</span><span class="s2"> &quot;</span>\
                    <span class="s2">&quot;is before the first afterglow time bin&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># The given flux is per unit of time.</span>
        <span class="c1"># In order to take into account that the last time bin is not completely</span>
        <span class="c1"># covered, it is corrected by the fraction in time in this bin.</span>
        <span class="n">dtprompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t90</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id90</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Prompt is active</span>
        <span class="n">dtslice</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id90</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id90</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Total slice duration</span>
        <span class="n">fraction</span> <span class="o">=</span> <span class="n">dtprompt</span><span class="o">/</span><span class="n">dtslice</span>

        <span class="c1"># All slices have weight 1 before the slice containing t90, the</span>
        <span class="c1"># fraction above for the slice containing t90, and zero beyond</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id90</span><span class="p">),</span>
                                  <span class="p">[</span><span class="n">fraction</span><span class="p">],</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">id90</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>

        <span class="c1">###----------------------------</span>
        <span class="c1">### Read prompt data</span>
        <span class="c1">###----------------------------</span>
        <span class="c1"># Open file - read the lines</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="n">gid</span><span class="o">+</span><span class="s2">&quot;-spec.dat&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">failure</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> does no exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">file</span>  <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="c1"># get Gamma and z</span>
        <span class="n">data</span>         <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">gamma_prompt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">redshift</span>     <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

        <span class="c1"># Consistency check - Zeljka data are rounded at 2 digits</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">redshift</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.01</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G0H</span> <span class="o">-</span> <span class="n">gamma_prompt</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">:</span>
            <span class="n">failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">:</span><span class="s2">10s</span><span class="si">}</span><span class="s2">: &quot;</span>\
                    <span class="sa">f</span><span class="s2">&quot;Afterglow / prompt : z= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="si">:</span><span class="s2">4.2f</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">redshift</span><span class="si">:</span><span class="s2">4.2f</span><span class="si">}</span><span class="s2">&quot;</span>\
                    <span class="sa">f</span><span class="s2">&quot;  G0H/gamma= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">G0H</span><span class="si">:</span><span class="s2">5.2f</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">gamma_prompt</span><span class="si">:</span><span class="s2">5.2f</span><span class="si">}</span><span class="s2">&quot;</span>\
                    <span class="sa">f</span><span class="s2">&quot; (G0W= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">G0W</span><span class="si">:</span><span class="s2">5.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Get units - omit &quot;ph&quot; in flux unit</span>
        <span class="n">data</span>     <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">unit_e</span>   <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">unit_flx</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]])[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Get flux points - assign units to data, use afterglow units</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">lines</span>
        <span class="n">Eval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fluxval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">4</span><span class="p">:]:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">Eval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">fluxval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">E_prompt</span>    <span class="o">=</span> <span class="n">Eval</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">unit_e</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux_prompt</span> <span class="o">=</span> <span class="n">fluxval</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="n">unit_flx</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unit_e</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="o">.</span><span class="n">unit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting energy units from </span><span class="si">{</span><span class="n">unit_e</span><span class="si">:}</span><span class="s2">&quot;</span>\
                        <span class="sa">f</span><span class="s2">&quot; to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="si">:}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_prompt</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unit_flx</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Converting flux units from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">&quot;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_flx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_prompt</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>

        <span class="c1">###----------------------------</span>
        <span class="c1">### Create a list of weighted models for non-zero weights</span>
        <span class="c1">###----------------------------</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id90</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">flux_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_prompt</span><span class="o">*</span><span class="n">weight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TemplateSpectralModel</span><span class="p">(</span><span class="n">energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_prompt</span><span class="p">,</span>
                                        <span class="n">values</span> <span class="o">=</span> <span class="n">flux_w</span><span class="p">,</span>
                                        <span class="n">interp_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;values_scale&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span><span class="p">}))</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Prompt associated to &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gamma = &quot;</span><span class="p">,</span><span class="n">gamma_prompt</span><span class="p">,</span><span class="s2">&quot; redshift =&quot;</span><span class="p">,</span><span class="n">redshift</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{:8}</span><span class="s2"> : </span><span class="si">{:10}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit_e</span><span class="p">,</span> <span class="n">unit_flx</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">E</span><span class="p">,</span> <span class="n">flux</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E_prompt</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_prompt</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{:8.2f}</span><span class="s2"> : </span><span class="si">{:10.2e}</span><span class="s2"> &quot;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
            <span class="n">islice</span><span class="o">=</span><span class="mi">0</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{:&gt;8}</span><span class="s2"> - </span><span class="si">{:&gt;5}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">,</span><span class="s2">&quot;Weight&quot;</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{:8.2f}</span><span class="s2"> - </span><span class="si">{:5.2f}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">w</span><span class="p">),</span><span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">islice</span><span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id90</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">islice</span><span class="o">+=</span><span class="mi">1</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Prompt is between: &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id90</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id90</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">models</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
    <span class="c1">### INPUT/OUPUT</span>
    <span class="c1">###------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Printout the GRB properties (Not the visibilities).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">txt</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  Read from      : </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  RA, DEC        : </span><span class="si">{:6.2f}</span><span class="s1"> </span><span class="si">{:6.2f}</span><span class="se">\n</span><span class="s1">&#39;</span> \
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radec</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">radec</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  Redshift       : </span><span class="si">{:6.2f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  EBL model      : &quot;</span><span class="si">{:}</span><span class="s1">&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eblmodel</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  Eiso           : </span><span class="si">{:6.2e}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eiso</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  Epeak          : </span><span class="si">{:6.2f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Epeak</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  t90            : </span><span class="si">{:6.2f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t90</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  G0H / G0W      : </span><span class="si">{:6.2f}</span><span class="s1"> / </span><span class="si">{:6.2f}</span><span class="se">\n</span><span class="s1">&#39;</span> \
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G0H</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">G0W</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  Flux peak      : </span><span class="si">{:6.2f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Fpeak</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  Flux peak (GBM): </span><span class="si">{:6.2f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Fpeak_GBM</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  gamma LE / HE  : </span><span class="si">{:6.2f}</span><span class="s1"> / </span><span class="si">{:6.2f}</span><span class="se">\n</span><span class="s1">&#39;</span> \
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gamle</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">gamhe</span><span class="p">)</span>

        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  t_trig         : </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_trig</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;iso&quot;</span><span class="p">))</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  Duration       : </span><span class="si">{:6.2f}</span><span class="s1"> </span><span class="si">{:10.2f}</span><span class="se">\n</span><span class="s1">&#39;</span> \
            <span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">),</span>
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
        <span class="c1"># txt += &#39;  Bins : E, t, dt    : {:4d} {:4d} {:4d} \n&#39; \</span>
        <span class="c1"># .format(len(self.Eval), len(self.tval), len(self.time_interval))</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  Bins : E, t    : </span><span class="si">{:4d}</span><span class="s1"> </span><span class="si">{:4d}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span> \
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39; Prompt component  : </span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;  Up to slice    : </span><span class="si">{:3d}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id90</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;  Bins : E       : </span><span class="si">{:3d}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E_prompt</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39; Prompt component not considered</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39; Visibility not available</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">return</span>  <span class="n">txt</span>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.write_to_bin"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.write_to_bin">[docs]</a>    <span class="k">def</span> <span class="nf">write_to_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write current instance to a binary file for further</span>
<span class="sd">        reuse.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        folder : String</span>
<span class="sd">            Folder name.</span>
<span class="sd">        debug : Boolean, optional</span>
<span class="sd">            If True, talks  bit. The default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s2">&quot;.bin&quot;</span><span class="p">)</span>
        <span class="n">outfile</span>  <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outfile</span><span class="p">)</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; GRB saved to : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.model_to_yaml"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.model_to_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">model_to_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;yaml&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump the time values for each energy specturm into a text file.</span>
<span class="sd">        Dump all spectra associated to the source into `yaml` files, tar and</span>
<span class="sd">        compresss the files, delete the originals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output : string, optional</span>
<span class="sd">            Output folder name. The default is &quot;yaml&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create dedicated folder</span>
        <span class="n">folder</span>    <span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">grb</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="kn">import</span> <span class="nn">os</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Now dumping &quot;</span><span class="p">,</span><span class="n">grb</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;to &quot;</span><span class="p">,</span><span class="n">folder</span><span class="p">)</span>

        <span class="c1"># Dump measurement times</span>
        <span class="n">name</span><span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="n">grb</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;_times.txt&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grb</span><span class="o">.</span><span class="n">tval</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:3d}</span><span class="s2"> </span><span class="si">{:&gt;8.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">),</span><span class="n">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Dump spectra and add to tar file</span>
        <span class="kn">from</span> <span class="nn">gammapy.modeling.models</span> <span class="kn">import</span> <span class="n">Models</span>
        <span class="kn">import</span> <span class="nn">tarfile</span>
        <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="n">grb</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.tar.gz&quot;</span><span class="p">),</span> <span class="s2">&quot;w:gz&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grb</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
            <span class="n">specname</span>     <span class="o">=</span> <span class="s2">&quot;spec_</span><span class="si">{:3s}</span><span class="s2">.yaml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">specfilename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="n">specname</span><span class="p">)</span>

            <span class="c1"># Dump data in yaml format</span>
            <span class="n">out</span>          <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">specfilename</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">Models</span><span class="p">([</span><span class="n">spec</span><span class="p">])</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(),</span><span class="n">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># Put spectrum in tar file</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">specfilename</span><span class="p">,</span><span class="n">arcname</span><span class="o">=</span><span class="n">specname</span><span class="p">)</span>

            <span class="c1"># Delete file</span>
            <span class="n">Path</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">specfilename</span><span class="p">)</span>

        <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.models_to_fits"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.models_to_fits">[docs]</a>    <span class="k">def</span> <span class="nf">models_to_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;model2fits&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function created to provide input to the Data Challenge, 2023.</span>
<span class="sd">        Store the spectra as yaml records inside an astropy.table Table</span>
<span class="sd">        associated to the valid time interval.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output : string, optional</span>
<span class="sd">            The output folder name. The default is &quot;fits&quot;.</span>
<span class="sd">        debug : Boolean, optional</span>
<span class="sd">            If True, say something. The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path.</span>
<span class="sd">            Output file Path.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create dedicated folder</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="c1"># Generate all yaml models and get the maximum length</span>
        <span class="n">yaml_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">Models</span><span class="p">([</span><span class="n">spec</span><span class="p">])</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">()</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">]</span>
        <span class="n">maxlength</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">yaml_list</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Max. yaml model length is &quot;</span><span class="p">,</span><span class="n">maxlength</span><span class="p">)</span>

        <span class="c1"># Fits filename</span>
        <span class="n">output_name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span><span class="s2">&quot;DC_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s2">&quot;.fits&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Now dumping &quot;</span><span class="p">,</span><span class="n">grb</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;to &quot;</span><span class="p">,</span><span class="n">output_name</span><span class="p">,</span><span class="s2">&quot; as a fits table&quot;</span><span class="p">)</span>

        <span class="c1"># Create an astropy table with 3 columns for spectra (same number of rows)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">table</span><span class="p">[</span><span class="s2">&quot;time_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">0e0</span><span class="p">],</span><span class="n">grb</span><span class="o">.</span><span class="n">tval</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="n">grb</span><span class="o">.</span><span class="n">tval</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">table</span><span class="p">[</span><span class="s2">&quot;time_stop&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">grb</span><span class="o">.</span><span class="n">tval</span>
        <span class="n">table</span><span class="p">[</span><span class="s2">&quot;mod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxlength</span><span class="o">*</span><span class="s2">&quot; &quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">yaml_list</span><span class="p">):</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;mod&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod</span>

        <span class="c1"># Add this stage, the data can be dumped into a fits file with</span>
        <span class="c1"># table.write(output_name, overwrite=True)</span>
        <span class="c1"># However, in order to modify the header we add a step</span>
        <span class="n">hdu_spectra</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">table</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;spectra&quot;</span><span class="p">)</span>

        <span class="c1"># Add explosion time in the header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">hdu_spectra</span><span class="o">.</span><span class="n">header</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;trigger&quot;</span><span class="p">]</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_trig</span><span class="o">.</span><span class="n">isot</span>

        <span class="c1"># Add visibility</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">t_true</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isot</span>   <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">t_true</span><span class="p">]</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isot</span>   <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">t_true</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">hdu_visN</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">table</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;vis_N&quot;</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="s2">&quot;South&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">t_true</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isot</span>   <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="s2">&quot;South&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">t_true</span><span class="p">]</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isot</span>   <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="s2">&quot;South&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">t_true</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">hdu_visS</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">table</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;vis_S&quot;</span><span class="p">)</span>

        <span class="c1"># Create the hdulist, write to output</span>
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">()</span>
        <span class="n">hdul</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu_spectra</span><span class="p">)</span>
        <span class="n">hdul</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu_visN</span><span class="p">)</span>
        <span class="n">hdul</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu_visS</span><span class="p">)</span>

        <span class="c1"># Write to file</span>
        <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">output_name</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">hdul</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">output_name</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.check_models_from_fits"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.check_models_from_fits">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_models_from_fits</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be checked and re-implemented or deleted.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : string</span>
<span class="sd">            Input file name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">hdul</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>

        <span class="c1"># Get trigger time</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trigger/explosion time :&quot;</span><span class="p">,</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;TRIGGER&quot;</span><span class="p">])</span>

        <span class="c1"># Get spectral data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time_start&quot;</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;time_stop&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;mod&quot;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">Models</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>

        <span class="c1"># Get visibility periods</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Visibility windows in North&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;VIS_N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;VIS_N&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Visibility windows in South&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;VIS_S&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="s2">&quot;VIS_S&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">])</span>

        <span class="n">hdul</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
    <span class="c1">### PLOTS</span>
    <span class="c1">###------------------------------------------------------------------------</span>

<div class="viewcode-block" id="GammaRayBurst.plot"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A series of plot of the present instance. The figures can also be</span>
<span class="sd">        printed to a pdf file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pdf : PdfPages instance, optional</span>
<span class="sd">            pdf output destination. The default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#plt.style.use(&#39;seaborn-talk&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-poster&#39;</span><span class="p">)</span> <span class="c1"># Bug with normal x marker !!!</span>

        <span class="n">fig_ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_time_spectra</span><span class="p">()</span>
        <span class="n">fig_es</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_energy_spectra</span><span class="p">()</span>
        <span class="n">fig_vn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">fig_vs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="s2">&quot;South&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_ts</span><span class="p">)</span>
            <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_es</span><span class="p">)</span>
            <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_vn</span><span class="p">)</span>
            <span class="n">pdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_vs</span><span class="p">)</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.plot_time_spectra"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.plot_time_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">plot_time_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_E_2disp</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
                                <span class="n">e_min</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span>
                                <span class="n">e_max</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
                                <span class="n">ymin</span><span class="o">=</span><span class="mf">1.e-20</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a series of lightcurves for some energies.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_E_2disp : integer, optional</span>
<span class="sd">            Number of energies to be sampled. The default is 6.</span>
<span class="sd">        e_min : Astropy Qauntity, optional</span>
<span class="sd">            Minimum energy. The default is 10*u.GeV.</span>
<span class="sd">        e_max : Astropy Qauntity, optional</span>
<span class="sd">            Maximal energy. The default is 10*u.TeV.</span>
<span class="sd">        ymin : float, optional</span>
<span class="sd">            Minimal ordinate value. The default is 1.e-20.</span>
<span class="sd">        ax : Matplotlib Axes, optional</span>
<span class="sd">            Current axis. The default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig : Matplotlib figure</span>
<span class="sd">            Current figure.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>

        <span class="c1"># Energy sampling</span>
        <span class="n">Emin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span> <span class="n">e_min</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">e_min</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="p">)</span>
        <span class="n">Emax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span> <span class="n">e_max</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">e_min</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">e_min</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Emin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Emax</span><span class="p">),</span> <span class="n">n_E_2disp</span><span class="p">)</span><span class="o">*</span><span class="n">e_min</span><span class="o">.</span><span class="n">unit</span>

        <span class="c1">### -----------------------------------</span>
        <span class="c1">### Compute the partial and total fluxes</span>
        <span class="c1">### -----------------------------------</span>

        <span class="c1"># Afterglow is always here</span>
        <span class="n">unit</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_afterglow</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mi">100</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">)</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">flx_glow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_afterglow</span><span class="p">])</span>
        <span class="n">flx_glow</span> <span class="o">=</span> <span class="n">flx_glow</span><span class="o">*</span><span class="n">unit</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">:</span>
            <span class="c1"># Prompt</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_prompt</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mi">100</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">)</span><span class="o">.</span><span class="n">unit</span>
            <span class="n">flx_prompt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_prompt</span><span class="p">])</span>
            <span class="n">flx_prompt</span> <span class="o">=</span> <span class="n">flx_prompt</span><span class="o">*</span><span class="n">unit</span>

            <span class="c1"># Prompt + afterglow</span>
            <span class="n">flx_tot</span> <span class="o">=</span> <span class="n">flx_prompt</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">flx_glow</span><span class="p">[:(</span><span class="bp">self</span><span class="o">.</span><span class="n">id90</span><span class="o">+</span><span class="mi">1</span><span class="p">),:]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">flx_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span><span class="n">flx_tot</span><span class="p">,</span><span class="n">flx_glow</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id90</span><span class="o">+</span><span class="mi">1</span><span class="p">:,:]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">unit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flx_tot</span> <span class="o">=</span> <span class="n">flx_glow</span>

        <span class="n">max_flx_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flx_tot</span><span class="p">)</span>

        <span class="c1"># Attenuated flux</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_model</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">)</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">flx_tot_att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">spectral_model</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">])</span>
        <span class="n">flx_tot_att</span> <span class="o">=</span> <span class="n">flx_tot_att</span><span class="o">*</span><span class="n">unit</span>

        <span class="c1">### -----------------------------------</span>
        <span class="c1">### Plot the various fluxes for the E series</span>
        <span class="c1">### -----------------------------------</span>
        <span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">)):</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">Dark2</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">E</span><span class="p">))</span>  <span class="c1"># cm.cool, cm.rainbow...</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">,</span><span class="n">flx_tot</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Total&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">,</span><span class="n">flx_glow</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">color</span><span class="o">=</span> <span class="n">color</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;afterglow&quot;</span><span class="p">)</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[:(</span><span class="bp">self</span><span class="o">.</span><span class="n">id90</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span>
                            <span class="n">flx_prompt</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prompt&quot;</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">,</span><span class="n">flx_tot_att</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t90</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t90</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">ymin</span><span class="p">,</span>
                         <span class="n">s</span><span class="o">=</span> <span class="s2">&quot;$t_</span><span class="si">{90}</span><span class="s2">$=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t90</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">t90</span><span class="o">.</span><span class="n">unit</span><span class="p">),</span>
                         <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">35</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.25</span><span class="o">*</span><span class="n">ymin</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s2">&quot;30 s&quot;</span><span class="p">,</span>
                        <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.05</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.25</span><span class="o">*</span><span class="n">ymin</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s2">&quot;1 d&quot;</span><span class="p">,</span>
                            <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">2.05</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.25</span><span class="o">*</span><span class="n">ymin</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s2">&quot;2 d&quot;</span><span class="p">,</span>
                            <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{:&gt;2d}</span><span class="s2"> E points&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">max_flx_tot</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgrey&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">single_legend</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">[</span><span class="mf">1.02</span><span class="p">,</span><span class="mf">0.5</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>
    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.plot_energy_spectra"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.plot_energy_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">plot_energy_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_t_2disp</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="mf">1e-16</span><span class="p">,</span>
                            <span class="n">e_min</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span> <span class="n">eindex</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                            <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Energy spectra for various measurement points in time.</span>

<span class="sd">        Note: the plot methods handle the labels, should not be overwritten</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_E_2disp : integer, optional</span>
<span class="sd">            Number of curves to show in energy spectra. The default is 5.</span>
<span class="sd">        ymin : float, optional</span>
<span class="sd">            Minimal flux value in current unit. The default is 1e-16.</span>
<span class="sd">        e_min : Quantity Energy, optional</span>
<span class="sd">            Minimal energy in the plot. The default is 1*u.GeV.</span>
<span class="sd">        eindex : integer, optionnal</span>
<span class="sd">            Flux is multiplied by Energy to eindex. The default is 2.</span>
<span class="sd">        ax : matplotlib axis, optional</span>
<span class="sd">            Figure axis. The default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig : Matplotlib figure</span>
<span class="sd">            Current figure.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">quantity_support</span>
        <span class="kn">from</span> <span class="nn">niceprint</span> <span class="kn">import</span> <span class="n">t_str</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>

        <span class="c1"># Compute number of spectra to be shown</span>
        <span class="n">nspectra</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">nspectra</span> <span class="o">&gt;</span> <span class="n">n_t_2disp</span><span class="p">:</span>
            <span class="n">dnt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">nspectra</span><span class="o">/</span><span class="n">n_t_2disp</span><span class="p">))</span>
            <span class="n">tidx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nspectra</span><span class="p">,</span><span class="n">dnt</span><span class="p">))</span>
            <span class="c1"># tidx = list(range(0,self.id90))</span>
            <span class="c1"># tidx = [12, 13, 14, 15] + tidx # Typical Prompt times</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dnt</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">tidx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>


        <span class="c1"># Plot in color some of the energy spectra and the initial data points</span>
        <span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>
            <span class="n">e_unit</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>
            <span class="n">flux_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit</span>
            <span class="c1"># In the present version, there is only one prompt spectrum up to t90</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">:</span> <span class="c1"># if no prompt id90 =-1</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E_prompt</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">e_unit</span><span class="p">),</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E_prompt</span><span class="o">**</span><span class="n">eindex</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_prompt</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$Prompt \ 0-t_</span><span class="si">{90}</span><span class="s2">$&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tidx</span><span class="p">:</span>
                <span class="n">t</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="c1"># Afterglow</span>

                <span class="c1"># Plot the GRB interpolated spectra</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">)],</span>
                                    <span class="n">ax</span><span class="p">,</span>
                                    <span class="n">energy_unit</span><span class="o">=</span><span class="n">e_unit</span><span class="p">,</span>  <span class="n">energy_power</span><span class="o">=</span><span class="n">eindex</span><span class="p">,</span>
                                    <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">flux_unit</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;t= </span><span class="si">{:&gt;s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_str</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>

                <span class="c1"># Plot the initial data points (should fit)</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span> <span class="c1"># Last color</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="o">**</span><span class="n">eindex</span><span class="o">*</span><span class="n">flux</span><span class="p">,</span>
                        <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

            <span class="c1"># Plot the rest faded out</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nspectra</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_model</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">)],</span><span class="n">ax</span><span class="p">,</span>
                                    <span class="n">energy_unit</span> <span class="o">=</span> <span class="n">e_unit</span><span class="p">,</span> <span class="n">energy_power</span><span class="o">=</span><span class="n">eindex</span><span class="p">,</span>
                                    <span class="n">flux_unit</span> <span class="o">=</span> <span class="n">flux_unit</span><span class="p">,</span>
                                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ymin</span><span class="o">*</span><span class="mi">50</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s2">&quot;10 GeV&quot;</span><span class="p">,</span>
                      <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: z=</span><span class="si">{:3.1f}</span><span class="s2"> - </span><span class="si">{}</span><span class="s2"> EBL -</span><span class="si">{:&gt;2d}</span><span class="s2"> Flux points&quot;</span>\
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eblmodel</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">n_t_2disp</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span> <span class="c1"># Too many t slices</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="n">ymin</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="n">e_min</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">e_unit</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.energy_and_time_2d"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.energy_and_time_2d">[docs]</a>    <span class="k">def</span> <span class="nf">energy_and_time_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Two-dimensionnal plot of flux versus energy and time.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>

            <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">a1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

            <span class="n">h</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxval</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">)</span>

            <span class="n">a1</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
            <span class="n">a1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;E (GeV)&quot;</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">a1</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">unit</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">)</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.energy_over_timeslices"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.energy_over_timeslices">[docs]</a>    <span class="k">def</span> <span class="nf">energy_over_timeslices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot energy spectra along the time bins.</span>
<span class="sd">        The number of Time bin is variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Compute grid size</span>
        <span class="n">idxmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">)</span>
        <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idxmax</span><span class="o">/</span><span class="n">ncols</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">idxmax</span><span class="o">%</span><span class="n">ncols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="o">-</span><span class="mi">1</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span>
                               <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">icol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncols</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nrows</span><span class="p">):</span>

                <span class="c1"># print(irow,icol,icol+ncols*irow)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">icol</span><span class="o">+</span><span class="n">ncols</span><span class="o">*</span><span class="n">irow</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">irow</span><span class="p">][</span><span class="n">icol</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">idxmax</span><span class="p">:</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                           <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
                           <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                           <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s2">&quot;t= </span><span class="si">{:06.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="n">a</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">4.5</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">22</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
                <span class="c1"># This has been thought ot be necessary - strange it works without</span>
                <span class="c1">#if (irow != nrows-1): a.set_xticklabels([])</span>
                <span class="c1"># if (icol != 0):       a.set_yticklabels([])</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># hide tick and tick label of the big axis</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                        <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$log(E (GeV))$&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$log(Flux (Gev^{-1} cm^{-2} s^{-1}) )$&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span> <span class="o">=</span> <span class="mf">.001</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.plot_altitude_and_flux"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.plot_altitude_and_flux">[docs]</a>    <span class="k">def</span> <span class="nf">plot_altitude_and_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span>
                          <span class="n">site</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">tshift</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
                          <span class="n">Eref</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span>
                          <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the altitude and flux of the GRB at the given energy, with</span>
<span class="sd">        a ccertain time shift.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        times : list of Astropy Time</span>
<span class="sd">            list of times, defined elsewhere.</span>
<span class="sd">        site : string, optional</span>
<span class="sd">            A string defining the site. The default is None.</span>
<span class="sd">        tshift : Astropy time, optional</span>
<span class="sd">            A time shift for the plot. The default is 0*u.s.</span>
<span class="sd">        Eref : Astropy Quantity, optional</span>
<span class="sd">            The reference energy. The default is 100*u.GeV.</span>
<span class="sd">        ax : Matplotlib Axes, optional</span>
<span class="sd">            Current axis. The default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax : Matplotlib Axes</span>
<span class="sd">            Current axis.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span> <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ax</span>

        <span class="c1">### Altitude sampling for plots - absolute time</span>
        <span class="n">altaz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radec</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">AltAz</span><span class="p">(</span><span class="n">obstime</span>  <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">times</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;mjd&quot;</span><span class="p">),</span>
                                               <span class="n">location</span> <span class="o">=</span> <span class="n">site</span><span class="p">))</span>

        <span class="c1">### Change time reference if requested</span>
        <span class="n">tref</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">t_trig</span> <span class="o">-</span> <span class="n">tshift</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">times</span> <span class="o">-</span> <span class="n">tshift</span> <span class="c1"># Change reference</span>

        <span class="c1">### GRB altitude and minimum</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
                <span class="n">altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkblue&quot;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Altitude&quot;</span><span class="p">)</span>

        <span class="c1">### FLux points -  Plot typical spectrum from the current source</span>
        <span class="n">axx</span>  <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

        <span class="n">flux</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">spectral_model</span><span class="p">(</span><span class="n">Eref</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> \
                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_model</span><span class="p">(</span><span class="n">Eref</span><span class="p">)</span><span class="o">.</span><span class="n">unit</span>
        <span class="n">axx</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_trig</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;mjd&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tval</span> <span class="o">-</span><span class="n">tshift</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
                  <span class="n">flux</span><span class="p">,</span>
                  <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                  <span class="n">ls</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span>
                  <span class="n">lw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:purple&quot;</span><span class="p">,</span>
                  <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$E \sim </span><span class="si">{}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Eref</span><span class="p">))</span>
        <span class="n">axx</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">axx</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


        <span class="c1">### Trigger (dot and vertical line)</span>
        <span class="n">alttrig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radec</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">AltAz</span><span class="p">(</span><span class="n">obstime</span>  <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_trig</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;mjd&quot;</span><span class="p">),</span>
                                           <span class="n">location</span> <span class="o">=</span> <span class="n">site</span><span class="p">))</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tref</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span><span class="n">alttrig</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Trigger&quot;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">tref</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>

        <span class="c1">### Trigger + 1 day (dot and vertical line)</span>
        <span class="n">altend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radec</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">AltAz</span><span class="p">(</span><span class="n">obstime</span>  <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_trig</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;mjd&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                          <span class="n">location</span> <span class="o">=</span> <span class="n">site</span><span class="p">))</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">tref</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span><span class="n">altend</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Trigger + 1 day&quot;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">((</span><span class="n">tref</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span><span class="mf">1.2</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">altaz</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;altitude (°)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.time_over_energyband"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.time_over_energyband">[docs]</a>    <span class="k">def</span> <span class="nf">time_over_energyband</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot time spectra along the energy bins.</span>
<span class="sd">        The number of energy bins is fixed.</span>

<span class="sd">        To be rearranged.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># coln = &quot;blue&quot;</span>
        <span class="c1"># cols = &quot;red&quot;</span>
        <span class="c1"># tb_n1 = self.vis[&quot;North&quot;].t_true[0]</span>
        <span class="c1"># tb_n2 = self.vis[&quot;North&quot;].t_true[1]</span>
        <span class="c1"># tb_s1 = self.vis[&quot;South&quot;].t_true[0]</span>
        <span class="c1"># tb_s2 = self.vis[&quot;South&quot;].t_true[1]</span>

        <span class="c1"># dt_n = (tb_n2 - tb_n1)/3600</span>
        <span class="c1"># dt_s = (tb_s2 - tb_s1)/3600</span>
        <span class="c1"># print(tbound_n, tbound_s)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">icol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>

                <span class="c1">#print(irow,icol,icol+8*irow)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">icol</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="n">irow</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">irow</span><span class="p">][</span><span class="n">icol</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;E= </span><span class="si">{:6.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Eval</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="c1">#print(idx,self.Eval[idx])</span>
                <span class="c1"># Artificially adds 1 s to avoid log(0)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="o">.</span><span class="n">value</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxval</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                       <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="c1"># Display visibility boundaties - Add articifially 1 second  to</span>
                <span class="c1"># avoid log(0)</span>
                <span class="c1"># if (dt_n):</span>
                <span class="c1">#     a.axvline(x=np.log10(tb_n1+1),linestyle =&quot;:&quot;,color=coln)</span>
                <span class="c1">#     a.axvline(x=np.log10(tb_n2+1),linestyle =&quot;:&quot;,color=coln)</span>
                <span class="c1"># if (dt_s):</span>
                <span class="c1">#     a.axvline(x=np.log10(tb_s1+1),linestyle =&quot;:&quot;,color=cols)</span>
                <span class="c1">#     a.axvline(x=np.log10(tb_s2+1),linestyle =&quot;:&quot;,color=cols)</span>

                <span class="n">a</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">5.5</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">22</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">irow</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">icol</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
                <span class="n">a</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
                <span class="n">a</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                <span class="c1">#a.set_xscale(&quot;log&quot;)</span>
                <span class="c1">#a.set_yscale(&quot;log&quot;)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># hide tick and tick label of the big axis</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                        <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$log(t + 1$ $(s))$&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$log(Flux$ $(Gev^{-1} cm^{-2} s^{-1}) )$&quot;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="c1"># title = self.id \</span>
        <span class="c1"># + &quot; Obs. : North = {:6.2f}h - South = {:6.2f}h&quot;.format(dt_n,dt_s)</span>

        <span class="c1"># fig.suptitle(title,size=16,y=0.9)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span> <span class="o">=</span> <span class="mf">.001</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

    <span class="c1">###------------------------------------------------------------------------</span>
<div class="viewcode-block" id="GammaRayBurst.animated_spectra"><a class="viewcode-back" href="../grb.html#grb.GammaRayBurst.animated_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">animated_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">emin</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">GeV</span><span class="p">,</span>
                               <span class="n">emax</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span><span class="p">,</span>
                               <span class="n">savefig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                               <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;./out/&#39;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a gif animation of time slices. To be finalised.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        emin : Astropy quantity, optional</span>
<span class="sd">            Minimal energy. The default is 0.02 * u.TeV.</span>
<span class="sd">        emax : Astropy quantity, optional</span>
<span class="sd">            Maximal energy. The default is 10 * u.TeV.</span>
<span class="sd">        savefig : Boolean, optional</span>
<span class="sd">            If True, save the animation to a file. The default is False.</span>
<span class="sd">        outdir : string, optional</span>
<span class="sd">            Output folder name. The default is &#39;./out/&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot; animated_spectra to be sorted out - but should work !&quot;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>

        <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_model</span>

        <span class="c1"># Initialise plot</span>
        <span class="n">fig_kw</span>  <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;_models&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="o">**</span><span class="n">fig_kw</span><span class="p">)</span>

        <span class="n">model_init</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span> <span class="o">=</span> <span class="n">model_init</span><span class="p">(</span><span class="n">energy</span><span class="o">=</span><span class="n">emax</span><span class="p">),</span> <span class="n">model_init</span><span class="p">(</span><span class="n">energy</span><span class="o">=</span><span class="n">emin</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">emin</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">emax</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">model_init</span><span class="p">(</span><span class="n">energy</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">emin</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">emax</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">fmin</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">fmax</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [TeV]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flux [1 / (cm2 s TeV)]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">1.e-20</span><span class="p">,</span> <span class="mf">1.e-6</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">### --------------------------------------------------</span>
        <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">energy</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
            <span class="n">line</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;; z=</span><span class="si">{:.2f}</span><span class="s1">; dt=</span><span class="si">{:6.2f}</span><span class="s1"> s&#39;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
         <span class="c1">### --------------------------------------------------</span>

        <span class="n">anim</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                             <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tval</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">savefig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;_animate.gif&#39;</span><span class="p">)</span>
            <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;ffmpeg&#39;</span><span class="p">)</span>
            <span class="c1"># anim.save(filename, writer=&#39;imagemagick&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div></div>

<span class="c1">###############################################################################</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A standalone function to read a GRB and make various tests</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">configuration</span> <span class="kn">import</span> <span class="n">Configuration</span>
    <span class="kn">from</span> <span class="nn">niceprint</span> <span class="kn">import</span> <span class="n">heading</span>

    <span class="c1"># This is required to have the EBL models read from gammapy</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GAMMAPY_DATA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                                          <span class="s2">&quot;data&quot;</span><span class="p">))</span>

    <span class="c1">###---------------------------</span>
    <span class="c1">### Input source data - copy of first SoHAPPy steps</span>
    <span class="c1">###---------------------------</span>
    <span class="n">cf</span> <span class="o">=</span> <span class="n">Configuration</span><span class="o">.</span><span class="n">command_line</span><span class="p">()</span>

    <span class="n">cf</span><span class="o">.</span><span class="n">ifirst</span>      <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cf</span><span class="o">.</span><span class="n">nsrc</span>        <span class="o">=</span> <span class="mi">1</span> <span class="c1"># 250</span>
    <span class="n">cf</span><span class="o">.</span><span class="n">prompt_dir</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cf</span><span class="o">.</span><span class="n">save_grb</span>    <span class="o">=</span> <span class="kc">False</span>
    <span class="n">grblist</span>        <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">source_ids</span><span class="p">()</span>

    <span class="n">data_path</span>   <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cf</span><span class="o">.</span><span class="n">infolder</span><span class="p">,</span><span class="n">cf</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span> <span class="c1"># Input data</span>
    <span class="n">cf</span><span class="o">.</span><span class="n">create_output_folder</span><span class="p">()</span>

    <span class="c1">###---------------------------</span>
    <span class="c1">### visibility parameters</span>
    <span class="c1">###---------------------------</span>
    <span class="n">case</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Computed from a keyword</span>
    <span class="k">if</span> <span class="n">case</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">cf</span><span class="o">.</span><span class="n">visibility</span> <span class="o">=</span> <span class="s2">&quot;strictmoonveto&quot;</span>

    <span class="c1"># Obtained from a directory as json files</span>
    <span class="k">if</span> <span class="n">case</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">cf</span><span class="o">.</span><span class="n">visibility</span> <span class="o">=</span> <span class="s2">&quot;visibility/long/vis_301_400_strictmoonveto.json&quot;</span>

    <span class="n">visinfo</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">decode_visibility_keyword</span><span class="p">()</span>

    <span class="c1">###---------------------------</span>
    <span class="c1">### Loop over sources</span>
    <span class="c1">###---------------------------</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grblist</span><span class="p">):</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">prefix</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">+</span><span class="n">cf</span><span class="o">.</span><span class="n">suffix</span>

        <span class="n">grb</span> <span class="o">=</span> <span class="n">GammaRayBurst</span><span class="o">.</span><span class="n">from_fits</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span><span class="n">fname</span><span class="p">),</span>
                                      <span class="n">prompt</span>  <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">prompt_dir</span><span class="p">,</span>
                                      <span class="n">ebl</span>     <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">ebl_model</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">,</span><span class="s2">&quot;South&quot;</span><span class="p">]:</span>
            <span class="n">grb</span><span class="o">.</span><span class="n">set_visibility</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">loc</span><span class="p">,</span><span class="n">info</span><span class="o">=</span><span class="n">visinfo</span><span class="p">)</span>

        <span class="n">heading</span><span class="p">(</span><span class="n">grb</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">grb</span><span class="p">)</span>

        <span class="c1"># Save GRB if requested</span>
        <span class="k">if</span> <span class="n">cf</span><span class="o">.</span><span class="n">save_grb</span> <span class="p">:</span> <span class="n">grb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">grb</span><span class="o">.</span><span class="n">vis</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;North&quot;</span><span class="p">,</span><span class="s2">&quot;South&quot;</span><span class="p">]:</span>
                <span class="n">grb</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">print</span><span class="p">()</span>

        <span class="n">grb</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="n">grb</span><span class="o">.</span><span class="n">energy_and_time_2d</span><span class="p">()</span>
        <span class="c1"># grb.animated_spectra(savefig=True)</span>
        <span class="n">grb</span><span class="o">.</span><span class="n">energy_over_timeslices</span><span class="p">()</span>
        <span class="n">grb</span><span class="o">.</span><span class="n">time_over_energyband</span><span class="p">()</span>

    <span class="c1"># ### -------------------</span>
    <span class="c1"># ### Actions for the Data Challenge</span>
    <span class="c1"># ### -------------------</span>
    <span class="c1"># grb_print = True</span>
    <span class="c1"># grb_plot  = True</span>
    <span class="c1"># save_grb  = False # (False) GRB saved to disk -&gt; use grb.py main</span>
    <span class="c1"># dump2yaml = False # Obsolete</span>
    <span class="c1"># dump2fits = False</span>
    <span class="c1"># debug     = True # dump2fits</span>


    <span class="c1">#     if dump2yaml: grb.model_to_yaml() # Dump GRB model to yaml files</span>

    <span class="c1">#     if dump2fits:</span>
    <span class="c1">#         filename = grb.models_to_fits(debug=debug) # Dump GRB model to fits files</span>
    <span class="c1">#         check_models_from_fits(filename) # Not a method</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Th. Stolarczyk.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>